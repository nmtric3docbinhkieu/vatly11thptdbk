<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V·∫≠t L√≠ 11 - 50 C√¢u H·ªèi C√≥ √Çm Thanh & MathJax</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$']],
                processEscapes: true
            },
            options: { processHtmlClass: 'tex2jax_process' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Nunito', sans-serif; background: #f1f5f9; }
        .glass-panel { background: white; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .btn-opt { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-opt:active { transform: scale(0.98); }
        .explanation-anim { animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // ========== C·∫§U H√åNH - Thay b·∫±ng gi√° tr·ªã c·ªßa b·∫°n khi deploy ==========
        const CONFIG = {
            supabaseUrl: 'https://bxffaxcimeturttxqrme.supabase.co',  // Thay YOUR_PROJECT b·∫±ng ID d·ª± √°n Supabase
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4ZmZheGNpbWV0dXJ0dHhxcm1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MDk1MzQsImV4cCI6MjA4NTk4NTUzNH0.uU3H707Qjfd2X4iQN3K9KKhsvNZkYn8v8zB_5lthzr0',            // L·∫•y t·ª´ Settings > API > anon public
            adminPassword: 'teacher123'                       // M·∫≠t kh·∫©u gi√°o vi√™n ƒë·ªÉ xu·∫•t Excel
        };

        // Supabase client (ch·ªâ kh·ªüi t·∫°o khi ƒë√£ c·∫•u h√¨nh)
        const getSupabase = () => {
            if (!CONFIG.supabaseUrl || CONFIG.supabaseUrl.includes('YOUR_PROJECT')) {
                console.error('‚ùå Supabase URL ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh!');
                return null;
            }
            if (!CONFIG.supabaseKey || CONFIG.supabaseKey.includes('YOUR_ANON_KEY')) {
                console.error('‚ùå Supabase Key ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh!');
                return null;
            }
            
            try {
                return window.supabase?.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey) || null;
            } catch (err) {
                console.error('‚ùå L·ªói khi t·∫°o Supabase client:', err);
                return null;
            }
        };

        // M√£ h√≥a m·∫≠t kh·∫©u (SHA-256 v·ªõi salt)
        const hashPassword = async (password, salt) => {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + salt + 'vatly11');
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
        };

        const STORAGE_KEY = 'vatly11_student';

        // √Çm thanh t·ª± t·∫°o b·∫±ng Web Audio API
        const useSound = () => {
            const audioCtx = useRef(null);

            const initAudio = () => {
                if (!audioCtx.current) {
                    audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.current.state === 'suspended') {
                    audioCtx.current.resume();
                }
            };

            const playCorrect = () => {
                initAudio();
                const osc = audioCtx.current.createOscillator();
                const gain = audioCtx.current.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, audioCtx.current.currentTime); // C5
                osc.frequency.exponentialRampToValueAtTime(880, audioCtx.current.currentTime + 0.1); // A5
                gain.gain.setValueAtTime(0.1, audioCtx.current.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.current.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(audioCtx.current.destination);
                osc.start();
                osc.stop(audioCtx.current.currentTime + 0.3);
            };

            const playWrong = () => {
                initAudio();
                const osc = audioCtx.current.createOscillator();
                const gain = audioCtx.current.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.current.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.current.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, audioCtx.current.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, audioCtx.current.currentTime + 0.2);
                osc.connect(gain);
                gain.connect(audioCtx.current.destination);
                osc.start();
                osc.stop(audioCtx.current.currentTime + 0.2);
            };

            return { playCorrect, playWrong, initAudio };
        };

        const questionDatabase = [
            // B√†i 11: ƒê·ªãnh lu·∫≠t Coulomb
            { q: "L·ª±c t∆∞∆°ng t√°c tƒ©nh ƒëi·ªán gi·ªØa hai ƒëi·ªán t√≠ch ƒëi·ªÉm t·ªâ l·ªá ngh·ªãch v·ªõi:", options: ["T√≠ch ƒë·ªô l·ªõn hai ƒëi·ªán t√≠ch", "Kho·∫£ng c√°ch gi·ªØa hai ƒëi·ªán t√≠ch", "B√¨nh ph∆∞∆°ng kho·∫£ng c√°ch gi·ªØa hai ƒëi·ªán t√≠ch", "H·∫±ng s·ªë ƒëi·ªán m√¥i"], a: 2, expl: "Theo ƒë·ªãnh lu·∫≠t Coulomb: $F = k \\frac{|q_1q_2|}{\\varepsilon r^2}$. L·ª±c $F$ t·ªâ l·ªá ngh·ªãch v·ªõi b√¨nh ph∆∞∆°ng kho·∫£ng c√°ch $r^2$." },
            { q: "H·∫±ng s·ªë ƒëi·ªán m√¥i c·ªßa ch√¢n kh√¥ng b·∫±ng:", options: ["0", "1", "2", "8,85.10^-12"], a: 1, expl: "Trong ch√¢n kh√¥ng, $\\varepsilon = 1$. ƒê√¢y l√† gi√° tr·ªã nh·ªè nh·∫•t c·ªßa h·∫±ng s·ªë ƒëi·ªán m√¥i." },
            { q: "ƒê∆°n v·ªã c·ªßa h·∫±ng s·ªë $k$ trong c√¥ng th·ª©c Coulomb l√†:", options: ["$C^2/N.m^2$", "$N.m^2/C^2$", "$V/m$", "$N/C$"], a: 1, expl: "T·ª´ c√¥ng th·ª©c $F = k \\frac{q^2}{r^2} \\Rightarrow k = \\frac{F \\cdot r^2}{q^2}$ n√™n ƒë∆°n v·ªã l√† $N \\cdot m^2 / C^2$." },
            { q: "N·∫øu ƒë·ªìng th·ªùi tƒÉng ƒë·ªô l·ªõn m·ªói ƒëi·ªán t√≠ch l√™n 2 l·∫ßn v√† gi·∫£m kho·∫£ng c√°ch ƒëi 2 l·∫ßn th√¨ l·ª±c Coulomb:", options: ["TƒÉng 4 l·∫ßn", "TƒÉng 8 l·∫ßn", "TƒÉng 16 l·∫ßn", "Kh√¥ng ƒë·ªïi"], a: 2, expl: "T·ª≠ s·ªë tƒÉng $2 \\times 2 = 4$. M·∫´u s·ªë gi·∫£m $2^2 = 4$. T·ªïng c·ªông l·ª±c tƒÉng $4 \\times 4 = 16$ l·∫ßn." },
            { q: "H·∫°t mang ƒëi·ªán t√≠ch nguy√™n t·ªë √¢m l√†:", options: ["Proton", "N∆°tron", "Electron", "H·∫°t nh√¢n"], a: 2, expl: "Electron mang ƒëi·ªán t√≠ch $-1,6 \\cdot 10^{-19} C$." },
            { q: "L·ª±c t∆∞∆°ng t√°c gi·ªØa hai ƒëi·ªán t√≠ch ƒëi·ªÉm $2 \\mu C$ v√† $-2 \\mu C$ c√°ch nhau 10cm trong ch√¢n kh√¥ng l√†:", options: ["3,6 N", "0,36 N", "36 N", "0,036 N"], a: 1, expl: "$F = 9 \\cdot 10^9 \\frac{|2 \\cdot 10^{-6} \\cdot (-2 \\cdot 10^{-6})|}{0,1^2} = 0,36 N$." },
            { q: "Trong c√°c ch·∫•t sau, ch·∫•t n√†o d·∫´n ƒëi·ªán t·ªët nh·∫•t?", options: ["N∆∞·ªõc tinh khi·∫øt", "Th·ªßy tinh", "ƒê·ªìng", "G·ªó kh√¥"], a: 2, expl: "ƒê·ªìng l√† kim lo·∫°i c√≥ nhi·ªÅu electron t·ª± do n√™n d·∫´n ƒëi·ªán t·ªët." },
            { q: "ƒê∆∞a hai ƒëi·ªán t√≠ch t·ª´ ch√¢n kh√¥ng v√†o m√¥i tr∆∞·ªùng c√≥ $\\varepsilon = 2$ th√¨ l·ª±c t∆∞∆°ng t√°c:", options: ["TƒÉng 2 l·∫ßn", "Gi·∫£m 2 l·∫ßn", "Gi·∫£m 4 l·∫ßn", "Kh√¥ng ƒë·ªïi"], a: 1, expl: "L·ª±c trong ƒëi·ªán m√¥i gi·∫£m $\\varepsilon$ l·∫ßn so v·ªõi ch√¢n kh√¥ng." },
            { q: "Kh·ªëi l∆∞·ª£ng c·ªßa m·ªôt electron x·∫•p x·ªâ b·∫±ng:", options: ["$1,67 \\cdot 10^{-27} kg$", "$9,1 \\cdot 10^{-31} kg$", "$1,6 \\cdot 10^{-19} kg$", "$9,1 \\cdot 10^{-19} kg$"], a: 1, expl: "$m_e \\approx 9,1 \\cdot 10^{-31} kg$." },
            { q: "Hai ƒëi·ªán t√≠ch ƒëi·ªÉm c√πng d·∫•u khi ƒë·∫∑t g·∫ßn nhau s·∫Ω:", options: ["H√∫t nhau", "ƒê·∫©y nhau", "Kh√¥ng t∆∞∆°ng t√°c", "L√∫c h√∫t l√∫c ƒë·∫©y"], a: 1, expl: "C√πng d·∫•u ƒë·∫©y nhau, tr√°i d·∫•u h√∫t nhau." },

            // B√†i 12: ƒêi·ªán tr∆∞·ªùng
            { q: "Vect∆° c∆∞·ªùng ƒë·ªô ƒëi·ªán tr∆∞·ªùng $\\vec{E}$ t·∫°i m·ªôt ƒëi·ªÉm ƒë·∫∑c tr∆∞ng cho ƒëi·ªán tr∆∞·ªùng v·ªÅ ph∆∞∆°ng di·ªán:", options: ["NƒÉng l∆∞·ª£ng", "T√°c d·ª•ng l·ª±c", "T·ªëc ƒë·ªô", "ƒê·ªô cao"], a: 1, expl: "$\\vec{E} = \\vec{F}/q$ ƒë·∫∑c tr∆∞ng cho kh·∫£ nƒÉng t√°c d·ª•ng l·ª±c c·ªßa ƒëi·ªán tr∆∞·ªùng." },
            { q: "ƒê∆°n v·ªã c·ªßa c∆∞·ªùng ƒë·ªô ƒëi·ªán tr∆∞·ªùng l√†:", options: ["V√¥n (V)", "Jun (J)", "V√¥n tr√™n m√©t (V/m)", "Ni-t∆°n (N)"], a: 2, expl: "ƒê∆°n v·ªã chu·∫©n l√† $V/m$." },
            { q: "ƒê∆∞·ªùng s·ª©c ƒëi·ªán c·ªßa m·ªôt ƒëi·ªán t√≠ch ƒëi·ªÉm √¢m c√≥ chi·ªÅu:", options: ["H∆∞·ªõng ra xa n√≥", "H∆∞·ªõng v·ªÅ ph√≠a n√≥", "Song song v·ªõi nhau", "ƒê∆∞·ªùng tr√≤n"], a: 1, expl: "ƒê∆∞·ªùng s·ª©c ƒëi·ªán ƒëi v√†o ƒëi·ªán t√≠ch √¢m." },
            { q: "ƒêi·ªán tr∆∞·ªùng ƒë·ªÅu c√≥ c√°c ƒë∆∞·ªùng s·ª©c ƒëi·ªán l√†:", options: ["C√°c ƒë∆∞·ªùng cong", "C√°c ƒë∆∞·ªùng th·∫≥ng song song c√°ch ƒë·ªÅu", "C√°c ƒë∆∞·ªùng tr√≤n", "C√°c ƒë∆∞·ªùng th·∫≥ng ƒë·ªìng quy"], a: 1, expl: "Trong ƒëi·ªán tr∆∞·ªùng ƒë·ªÅu, $\\vec{E}$ t·∫°i m·ªçi ƒëi·ªÉm l√† nh∆∞ nhau." },
            { q: "C√¥ng th·ª©c $E = k \\frac{|Q|}{r^2}$ d√πng ƒë·ªÉ t√≠nh c∆∞·ªùng ƒë·ªô ƒëi·ªán tr∆∞·ªùng c·ªßa:", options: ["V·∫≠t d·∫´n b·∫•t k√¨", "ƒêi·ªán t√≠ch ƒëi·ªÉm", "T·ª• ƒëi·ªán", "D√≤ng ƒëi·ªán"], a: 1, expl: "ƒê√¢y l√† c√¥ng th·ª©c cho ƒëi·ªán t√≠ch ƒëi·ªÉm g√¢y ra t·∫°i ƒëi·ªÉm c√°ch n√≥ kho·∫£ng r." },
            { q: "T·∫°i m·ªôt ƒëi·ªÉm trong ƒëi·ªán tr∆∞·ªùng, n·∫øu ta tƒÉng ƒë·ªô l·ªõn ƒëi·ªán t√≠ch th·ª≠ q l√™n 2 l·∫ßn th√¨ E t·∫°i ƒë√≥:", options: ["TƒÉng 2 l·∫ßn", "Gi·∫£m 2 l·∫ßn", "Kh√¥ng ƒë·ªïi", "TƒÉng 4 l·∫ßn"], a: 2, expl: "C∆∞·ªùng ƒë·ªô ƒëi·ªán tr∆∞·ªùng E ch·ªâ ph·ª• thu·ªôc ngu·ªìn g√¢y ra n√≥, kh√¥ng ph·ª• thu·ªôc ƒëi·ªán t√≠ch th·ª≠ q." },
            { q: "Nguy√™n l√≠ ch·ªìng ch·∫•t ƒëi·ªán tr∆∞·ªùng gi√∫p ta t√≠nh E t·ªïng h·ª£p b·∫±ng c√°ch:", options: ["C·ªông ƒë·∫°i s·ªë c√°c ƒë·ªô l·ªõn", "C·ªông vect∆° c√°c E th√†nh ph·∫ßn", "L·∫•y hi·ªáu c√°c ƒë·ªô l·ªõn", "Nh√¢n c√°c ƒë·ªô l·ªõn"], a: 1, expl: "$\\vec{E} = \\vec{E_1} + \\vec{E_2} + ...$" },
            { q: "ƒê∆∞·ªùng s·ª©c ƒëi·ªán kh√¥ng bao gi·ªù:", options: ["ƒêi ra t·ª´ ƒëi·ªán t√≠ch d∆∞∆°ng", "C·∫Øt nhau", "T·∫≠n c√πng ·ªü v√¥ c·ª±c", "C√≥ h√¨nh d·∫°ng ƒë∆∞·ªùng th·∫≥ng"], a: 1, expl: "C√°c ƒë∆∞·ªùng s·ª©c ƒëi·ªán kh√¥ng bao gi·ªù giao nhau t·∫°i m·ªôt ƒëi·ªÉm." },
            { q: "C∆∞·ªùng ƒë·ªô ƒëi·ªán tr∆∞·ªùng $E = 1000 V/m$, l·ª±c ƒëi·ªán t√°c d·ª•ng l√™n $q = 1 \\mu C$ l√†:", options: ["$10^{-3} N$", "$10^{-6} N$", "$1 N$", "$1000 N$"], a: 0, expl: "$F = qE = 10^{-6} \\cdot 1000 = 10^{-3} N$." },
            { q: "Trong ƒëi·ªán tr∆∞·ªùng ƒë·ªÅu, l·ª±c ƒëi·ªán t√°c d·ª•ng l√™n m·ªôt ƒëi·ªán t√≠ch q l√†:", options: ["Thay ƒë·ªïi theo v·ªã tr√≠", "Lu√¥n b·∫±ng 0", "Kh√¥ng ƒë·ªïi v·ªÅ h∆∞·ªõng v√† ƒë·ªô l·ªõn", "T·ªâ l·ªá v·ªõi kho·∫£ng c√°ch"], a: 2, expl: "V√¨ $\\vec{E}$ kh√¥ng ƒë·ªïi n√™n $\\vec{F} = q\\vec{E}$ c≈©ng kh√¥ng ƒë·ªïi." },

            // B√†i 13: ƒêi·ªán th·∫ø - Th·∫ø nƒÉng
            { q: "C√¥ng c·ªßa l·ª±c ƒëi·ªán tr∆∞·ªùng khi q di chuy·ªÉn trong ƒëi·ªán tr∆∞·ªùng ƒë·ªÅu l√† $A = qEd$. d l√†:", options: ["Qu√£ng ƒë∆∞·ªùng ƒëi", "H√¨nh chi·∫øu qu√£ng ƒë∆∞·ªùng l√™n ph∆∞∆°ng ƒë∆∞·ªùng s·ª©c", "Kho·∫£ng c√°ch ƒë·∫ßu cu·ªëi", "B√°n k√≠nh qu·ªπ ƒë·∫°o"], a: 1, expl: "d l√† h√¨nh chi·∫øu c·ªßa vect∆° d·ªãch chuy·ªÉn l√™n ph∆∞∆°ng c·ªßa vect∆° $\\vec{E}$." },
            { q: "ƒêi·ªán th·∫ø $V_M$ ƒë·∫∑c tr∆∞ng cho ƒëi·ªán tr∆∞·ªùng v·ªÅ m·∫∑t:", options: ["T√°c d·ª•ng l·ª±c", "NƒÉng l∆∞·ª£ng (kh·∫£ nƒÉng sinh c√¥ng)", "ƒê·ªô m·∫°nh y·∫øu", "Chi·ªÅu c·ªßa ƒë∆∞·ªùng s·ª©c"], a: 1, expl: "ƒêi·ªán th·∫ø l√† ƒë·∫°i l∆∞·ª£ng ƒë·∫∑c tr∆∞ng cho kh·∫£ nƒÉng sinh c√¥ng t·∫°i m·ªôt ƒëi·ªÉm." },
            { q: "Hi·ªáu ƒëi·ªán th·∫ø $U_{MN}$ gi·ªØa hai ƒëi·ªÉm M v√† N b·∫±ng:", options: ["$V_N - V_M$", "$V_M - V_N$", "$V_M + V_N$", "$V_M \\cdot V_N$"], a: 1, expl: "$U_{MN} = V_M - V_N$." },
            { q: "C√¥ng th·ª©c li√™n h·ªá $E$ v√† $U$ trong ƒëi·ªán tr∆∞·ªùng ƒë·ªÅu l√†:", options: ["$U = E/d$", "$E = U \\cdot d$", "$E = U/d$", "$U = E \\cdot d^2$"], a: 2, expl: "Nh·ªõ m·∫πo: 'U b·∫±ng E nh√¢n d' hay 'E b·∫±ng U chia d'." },
            { q: "M·ªôt ƒëi·ªán t√≠ch $2C$ d·ªãch chuy·ªÉn d∆∞·ªõi hi·ªáu ƒëi·ªán th·∫ø $10V$ th√¨ c√¥ng l·ª±c ƒëi·ªán l√†:", options: ["5 J", "20 J", "0,2 J", "12 J"], a: 1, expl: "$A = qU = 2 \\cdot 10 = 20 J$." },
            { q: "N·∫øu m·ªôt ƒëi·ªán t√≠ch di chuy·ªÉn vu√¥ng g√≥c v·ªõi ƒë∆∞·ªùng s·ª©c ƒëi·ªán th√¨ c√¥ng l·ª±c ƒëi·ªán b·∫±ng:", options: ["C·ª±c ƒë·∫°i", "0", "C·ª±c ti·ªÉu", "qEd"], a: 1, expl: "Khi vu√¥ng g√≥c, h√¨nh chi·∫øu $d = 0 \\Rightarrow A = 0$." },
            { q: "ƒê∆°n v·ªã c·ªßa ƒëi·ªán th·∫ø l√†:", options: ["Jun (J)", "V√¥n (V)", "Ni-t∆°n (N)", "Cu-l√¥ng (C)"], a: 1, expl: "ƒêi·ªán th·∫ø ƒëo b·∫±ng V√¥n." },
            { q: "Th·∫ø nƒÉng c·ªßa m·ªôt electron t·∫°i ƒëi·ªÉm c√≥ ƒëi·ªán th·∫ø $V = 10V$ l√†:", options: ["$1,6 \\cdot 10^{-18} J$", "$-1,6 \\cdot 10^{-18} J$", "$10 J$", "$-10 J$"], a: 1, expl: "$W = qV = (-1,6 \\cdot 10^{-19}) \\cdot 10 = -1,6 \\cdot 10^{-18} J$." },
            { q: "Khi di chuy·ªÉn c√πng chi·ªÅu ƒë∆∞·ªùng s·ª©c ƒëi·ªán, ƒëi·ªán th·∫ø s·∫Ω:", options: ["TƒÉng d·∫ßn", "Gi·∫£m d·∫ßn", "Kh√¥ng ƒë·ªïi", "B·∫±ng 0"], a: 1, expl: "Vect∆° $\\vec{E}$ lu√¥n h∆∞·ªõng t·ª´ n∆°i c√≥ ƒëi·ªán th·∫ø cao sang n∆°i c√≥ ƒëi·ªán th·∫ø th·∫•p." },
            { q: "C√¥ng c·ªßa l·ª±c ƒëi·ªán tr∆∞·ªùng kh√¥ng ph·ª• thu·ªôc v√†o:", options: ["ƒêi·ªán t√≠ch q", "C∆∞·ªùng ƒë·ªô ƒëi·ªán tr∆∞·ªùng", "H√¨nh d·∫°ng qu·ªπ ƒë·∫°o", "V·ªã tr√≠ ƒëi·ªÉm ƒë·∫ßu cu·ªëi"], a: 2, expl: "L·ª±c ƒëi·ªán l√† l·ª±c th·∫ø, c√¥ng kh√¥ng ph·ª• thu·ªôc h√¨nh d·∫°ng ƒë∆∞·ªùng ƒëi." },

            // B√†i 14: T·ª• ƒëi·ªán
            { q: "ƒêi·ªán dung $C$ c·ªßa t·ª• ƒëi·ªán ƒë·∫∑c tr∆∞ng cho:", options: ["Kh·∫£ nƒÉng t√≠ch ƒëi·ªán", "Kh·∫£ nƒÉng t·ªèa nhi·ªát", "ƒê·ªô b·ªÅn c·ªßa t·ª•", "Th·ªÉ t√≠ch c·ªßa t·ª•"], a: 0, expl: "$C$ c√†ng l·ªõn th√¨ t·ª• t√≠ch ƒë∆∞·ª£c c√†ng nhi·ªÅu ƒëi·ªán t√≠ch ·ªü c√πng m·ªôt hi·ªáu ƒëi·ªán th·∫ø." },
            { q: "C√¥ng th·ª©c t√≠nh ƒëi·ªán dung l√†:", options: ["$C = QU$", "$C = Q/U$", "$C = U/Q$", "$C = 1/2 QU$"], a: 1, expl: "$C = Q/U$." },
            { q: "NƒÉng l∆∞·ª£ng c·ªßa t·ª• ƒëi·ªán ƒë√£ t√≠ch ƒëi·ªán t·ªâ l·ªá thu·∫≠n v·ªõi:", options: ["Hi·ªáu ƒëi·ªán th·∫ø U", "B√¨nh ph∆∞∆°ng hi·ªáu ƒëi·ªán th·∫ø $U^2$", "CƒÉn b·∫≠c hai c·ªßa U", "Ngh·ªãch l·ªá v·ªõi U"], a: 1, expl: "$W = 1/2 CU^2$." },
            { q: "ƒê∆°n v·ªã Fara ($F$) t∆∞∆°ng ƒë∆∞∆°ng v·ªõi:", options: ["$1 V/C$", "$1 C/V$", "$1 J/C$", "$1 C \\cdot V$"], a: 1, expl: "T·ª´ $C = Q/U$, ƒë∆°n v·ªã l√† $Coulomb / Volt$." },
            { q: "Khi gh√©p song song hai t·ª• ƒëi·ªán $C_1$ v√† $C_2$, ƒëi·ªán dung t∆∞∆°ng ƒë∆∞∆°ng l√†:", options: ["$C = C_1 + C_2$", "$C = C_1 \\cdot C_2 / (C_1+C_2)$", "$1/C = 1/C_1 + 1/C_2$", "$C = C_1 - C_2$"], a: 0, expl: "Song song th√¨ c·ªông ƒëi·ªán dung." },
            { q: "M·ªôt t·ª• ƒëi·ªán ghi $10 \\mu F - 250V$. S·ªë 250V cho bi·∫øt:", options: ["Hi·ªáu ƒëi·ªán th·∫ø t·ª• lu√¥n c√≥", "Hi·ªáu ƒëi·ªán th·∫ø ƒë·ªãnh m·ª©c (t·ªëi ƒëa)", "Hi·ªáu ƒëi·ªán th·∫ø n·∫°p ƒëi·ªán", "Su·∫•t ƒëi·ªán ƒë·ªông"], a: 1, expl: "ƒê√¢y l√† gi·ªõi h·∫°n an to√†n c·ªßa t·ª•." },
            { q: "ƒê·ªÉ tƒÉng ƒëi·ªán dung c·ªßa t·ª• ƒëi·ªán ph·∫≥ng, ta c√≥ th·ªÉ:", options: ["TƒÉng hi·ªáu ƒëi·ªán th·∫ø", "Gi·∫£m kho·∫£ng c√°ch d gi·ªØa hai b·∫£n", "Gi·∫£m di·ªán t√≠ch b·∫£n t·ª•", "R√∫t b·ªõt ƒëi·ªán t√≠ch"], a: 1, expl: "$C = \\frac{\\varepsilon S}{4\\pi kd}$, $C$ t·ªâ l·ªá ngh·ªãch v·ªõi $d$." },
            { q: "NƒÉng l∆∞·ª£ng c·ªßa t·ª• ƒëi·ªán t√≠ch tr·ªØ ·ªü d·∫°ng:", options: ["NƒÉng l∆∞·ª£ng t·ª´ tr∆∞·ªùng", "NƒÉng l∆∞·ª£ng ƒëi·ªán tr∆∞·ªùng", "C∆° nƒÉng", "H√≥a nƒÉng"], a: 1, expl: "NƒÉng l∆∞·ª£ng n·∫±m trong v√πng kh√¥ng gian c√≥ ƒëi·ªán tr∆∞·ªùng gi·ªØa hai b·∫£n t·ª•." },
            { q: "T·ª• ƒëi·ªán c√≥ ƒëi·ªán dung $2 \\mu F$, t√≠ch ƒëi·ªán $4 \\mu C$. Hi·ªáu ƒëi·ªán th·∫ø l√†:", options: ["8 V", "0,5 V", "2 V", "6 V"], a: 2, expl: "$U = Q/C = 4/2 = 2 V$." },
            { q: "Khi ng·∫Øt t·ª• kh·ªèi ngu·ªìn r·ªìi tƒÉng kho·∫£ng c√°ch 2 b·∫£n, ƒë·∫°i l∆∞·ª£ng n√†o kh√¥ng ƒë·ªïi?", options: ["ƒêi·ªán dung C", "Hi·ªáu ƒëi·ªán th·∫ø U", "ƒêi·ªán t√≠ch Q", "NƒÉng l∆∞·ª£ng W"], a: 2, expl: "Ng·∫Øt kh·ªèi ngu·ªìn th√¨ ƒëi·ªán t√≠ch b·ªã c√¥ l·∫≠p n√™n $Q$ kh√¥ng ƒë·ªïi." },

            // B·ªï sung c√°c c√¢u t·ªïng h·ª£p
            { q: "Nguy√™n t·ª≠ trung h√≤a v·ªÅ ƒëi·ªán v√¨:", options: ["C√≥ nhi·ªÅu electron h∆°n proton", "S·ªë proton b·∫±ng s·ªë electron", "Kh√¥ng c√≥ ƒëi·ªán t√≠ch", "H·∫°t nh√¢n mang ƒëi·ªán √¢m"], a: 1, expl: "ƒêi·ªán t√≠ch d∆∞∆°ng c·ªßa h·∫°t nh√¢n tri·ªát ti√™u ƒëi·ªán t√≠ch √¢m c·ªßa v·ªè electron." },
            { q: "H·∫±ng s·ªë ƒëi·ªán m√¥i c·ªßa m·ªôt ch·∫•t cho bi·∫øt l·ª±c t∆∞∆°ng t√°c ƒëi·ªán gi·∫£m ƒëi bao nhi√™u l·∫ßn so v·ªõi:", options: ["Kim lo·∫°i", "Ch√¢n kh√¥ng", "N∆∞·ªõc", "Kh√¥ng kh√≠"], a: 1, expl: "H·∫±ng s·ªë ƒëi·ªán m√¥i $\\varepsilon$ l·∫•y ch√¢n kh√¥ng l√†m chu·∫©n." },
            { q: "ƒêi·ªán ph·ªï l√†:", options: ["T·∫≠p h·ª£p c√°c ƒë∆∞·ªùng s·ª©c ƒëi·ªán", "B·∫£ng gi√° tr·ªã ƒëi·ªán th·∫ø", "H√¨nh ·∫£nh c√°c h·∫°t b·ª•i x·∫øp theo ƒë∆∞·ªùng s·ª©c", "M√†u s·∫Øc c·ªßa ƒëi·ªán tr∆∞·ªùng"], a: 2, expl: "ƒêi·ªán ph·ªï gi√∫p ta h√¨nh dung h√¨nh d·∫°ng c√°c ƒë∆∞·ªùng s·ª©c ƒëi·ªán trong th·ª±c t·∫ø." },
            { q: "Khi ƒëi ng∆∞·ª£c chi·ªÅu ƒë∆∞·ªùng s·ª©c ƒëi·ªán c·ªßa m·ªôt ƒëi·ªán tr∆∞·ªùng ƒë·ªÅu, ƒëi·ªán th·∫ø s·∫Ω:", options: ["TƒÉng", "Gi·∫£m", "Kh√¥ng ƒë·ªïi", "B·∫±ng 0"], a: 0, expl: "Chi·ªÅu $\\vec{E}$ l√† chi·ªÅu gi·∫£m ƒëi·ªán th·∫ø, n√™n ƒëi ng∆∞·ª£c l·∫°i l√† tƒÉng ƒëi·ªán th·∫ø." },
            { q: "M·ªôt qu·∫£ c·∫ßu kim lo·∫°i mang ƒëi·ªán $q$. N·∫øu ch·∫°m qu·∫£ c·∫ßu n√†y v√†o m·ªôt qu·∫£ c·∫ßu kh√°c gi·ªëng h·ªát ƒëang trung h√≤a th√¨ ƒëi·ªán t√≠ch m·ªói qu·∫£ l√†:", options: ["q", "2q", "q/2", "0"], a: 2, expl: "Nhi·ªÖm ƒëi·ªán do ti·∫øp x√∫c: ƒëi·ªán t√≠ch chia ƒë·ªÅu cho hai v·∫≠t gi·ªëng nhau." },
            { q: "C√¥ng th·ª©c $A = q(V_M - V_N)$ ƒë√∫ng cho:", options: ["Ch·ªâ ƒëi·ªán tr∆∞·ªùng ƒë·ªÅu", "M·ªçi ƒëi·ªán tr∆∞·ªùng", "Ch·ªâ ƒëi·ªán t√≠ch ƒëi·ªÉm", "Ch·ªâ t·ª• ƒëi·ªán"], a: 1, expl: "ƒê√¢y l√† ƒë·ªãnh nghƒ©a t·ªïng qu√°t v·ªÅ c√¥ng v√† ƒëi·ªán th·∫ø." },
            { q: "ƒê∆°n v·ªã $1 nC$ (nanocoulomb) b·∫±ng:", options: ["$10^{-3} C$", "$10^{-6} C$", "$10^{-9} C$", "$10^{-12} C$"], a: 2, expl: "Nano l√† $10^{-9}$." },
            { q: "B·∫£n ch·∫•t c·ªßa d√≤ng ƒëi·ªán trong kim lo·∫°i l√† d√≤ng d·ªãch chuy·ªÉn c√≥ h∆∞·ªõng c·ªßa:", options: ["Ion d∆∞∆°ng", "Ion √¢m", "Electron t·ª± do", "Proton"], a: 2, expl: "Kim lo·∫°i d·∫´n ƒëi·ªán nh·ªù c√°c electron t·ª± do." },
            { q: "Trong c√¥ng th·ª©c Coulomb, n·∫øu r tƒÉng l√™n g·∫•p ƒë√¥i th√¨ F thay ƒë·ªïi nh∆∞ th·∫ø n√†o?", options: ["TƒÉng 2 l·∫ßn", "Gi·∫£m 2 l·∫ßn", "TƒÉng 4 l·∫ßn", "Gi·∫£m 4 l·∫ßn"], a: 3, expl: "$F \\sim 1/r^2$. r tƒÉng 2 th√¨ F gi·∫£m $2^2 = 4$ l·∫ßn." },
            { q: "M·ªôt v·∫≠t d·∫´n c√¢n b·∫±ng ƒëi·ªán th√¨ c∆∞·ªùng ƒë·ªô ƒëi·ªán tr∆∞·ªùng t·∫°i m·ªôt ƒëi·ªÉm b√™n trong v·∫≠t d·∫´n b·∫±ng:", options: ["C·ª±c ƒë·∫°i", "B·∫±ng E m·∫∑t ngo√†i", "0", "Ph·ª• thu·ªôc h√¨nh d·∫°ng"], a: 2, expl: "Trong v·∫≠t d·∫´n c√¢n b·∫±ng, ƒëi·ªán tr∆∞·ªùng b·∫±ng 0 ƒë·ªÉ c√°c ƒëi·ªán t√≠ch kh√¥ng di chuy·ªÉn th√™m n·ªØa." }
        ];

        function App() {
            const [gameState, setGameState] = useState('start');
            const [currentIdx, setCurrentIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [selected, setSelected] = useState(null);
            const [showExpl, setShowExpl] = useState(false);
            const [questions, setQuestions] = useState([]);
            const { playCorrect, playWrong, initAudio } = useSound();

            // Tr·∫°ng th√°i ch·ªëng gian l·∫≠n
            const [cheatWarnings, setCheatWarnings] = useState(0);
            const [showCheatAlert, setShowCheatAlert] = useState(false);
            const [isTestActive, setIsTestActive] = useState(false);

            // Tr·∫°ng th√°i theo d√µi th·ªùi gian
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [leaderboard, setLeaderboard] = useState([]);
            const [showLeaderboard, setShowLeaderboard] = useState(false);
            const [loadingLeaderboard, setLoadingLeaderboard] = useState(false);

            // Tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
            const [student, setStudent] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : null;
                } catch { return null; }
            });
            const [authMode, setAuthMode] = useState('login'); // 'login' | 'register'
            const [authForm, setAuthForm] = useState({ fullName: '', className: '', password: '' });
            const [authError, setAuthError] = useState('');
            const [authLoading, setAuthLoading] = useState(false);

            // Ch·∫ø ƒë·ªô admin (xu·∫•t Excel)
            const [adminMode, setAdminMode] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');
            const [adminError, setAdminError] = useState('');
            const [exportLoading, setExportLoading] = useState(false);

            const renderMath = useCallback(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise();
                }
            }, []);

            useEffect(() => {
                if (gameState === 'playing' || showExpl || gameState === 'summary') {
                    setTimeout(renderMath, 50);
                }
            }, [currentIdx, gameState, showExpl, renderMath]);

            // Ki·ªÉm tra k·∫øt n·ªëi Supabase khi component t·∫£i
            useEffect(() => {
                const supabase = getSupabase();
                if (supabase) {
                    console.log('‚úÖ Supabase ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng');
                    console.log('URL:', CONFIG.supabaseUrl);
                } else {
                    console.error('‚ùå Kh√¥ng th·ªÉ kh·ªüi t·∫°o Supabase!');
                    console.error('URL:', CONFIG.supabaseUrl);
                    console.error('Key t·ªìn t·∫°i:', !!CONFIG.supabaseKey);
                }
            }, []);

            // Theo d√µi th·ªùi gian l√†m b√†i
            useEffect(() => {
                let interval;
                if (isTestActive && startTime) {
                    interval = setInterval(() => {
                        setElapsedTime(Math.floor((Date.now() - startTime) / 1000));
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isTestActive, startTime]);

            // L·∫•y d·ªØ li·ªáu b·∫£ng x·∫øp h·∫°ng
            const fetchLeaderboard = async () => {
    const supabase = getSupabase();
    if (!supabase) return;
    
    setLoadingLeaderboard(true);
    
    // üëá T·∫†O ABORT CONTROLLER
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    
    try {
        const { data, error } = await supabase
            .from('leaderboard')
            .select('*')
            .limit(50)
            .abortSignal(controller.signal); // üëâ G·∫ÆN SIGNAL
        
        clearTimeout(timeoutId);
        
        if (error) throw error;
        setLeaderboard(data || []);
        
    } catch (err) {
        // üëá CH·∫∂N HO√ÄN TO√ÄN L·ªñI FETCHERROR
        if (err.name === 'AbortError' || err.name === 'FetchError') {
            console.log('‚è±Ô∏è B·ªè qua l·ªói timeout/network - kh√¥ng ·∫£nh h∆∞·ªüng app');
            return;
        }
        console.error('L·ªói kh√°c:', err);
    } finally {
        setLoadingLeaderboard(false);
    }
};

            // H√†m ƒë·ªãnh d·∫°ng th·ªùi gian t·ª´ gi√¢y sang ph√∫t:gi√¢y
            const formatTime = (seconds) => {
                if (!seconds || seconds < 0) return '0:00';
                const secs = Math.floor(seconds);
                const mins = Math.floor(secs / 60);
                const remainingSecs = secs % 60;
                return `${mins}:${remainingSecs.toString().padStart(2, '0')}`;
            };

            // Ch·ªëng gian l·∫≠n - theo d√µi vi·ªác chuy·ªÉn tab
            useEffect(() => {
                let isCheatDetected = false; // Flag ƒë·ªÉ tr√°nh ƒë·∫øm tr√πng
                
                const handleCheatDetection = () => {
                    if (isTestActive && !isCheatDetected) {
                        isCheatDetected = true;
                        setCheatWarnings(prev => prev + 1);
                        setShowCheatAlert(true);
                        
                        // Ghi log gian l·∫≠n
                        console.warn(`C·∫¢NH B√ÅO GIAN L·∫¨N: ${student?.full_name || 'Unknown'} ƒë√£ r·ªùi kh·ªèi tab thi`);
                        
                        // Reset flag sau 2 gi√¢y ƒë·ªÉ c√≥ th·ªÉ ph√°t hi·ªán l·∫ßn ti·∫øp theo
                        setTimeout(() => {
                            isCheatDetected = false;
                        }, 2000);
                        
                        // T·ª± ƒë·ªông ·∫©n c·∫£nh b√°o sau 5 gi√¢y
                        setTimeout(() => {
                            setShowCheatAlert(false);
                        }, 5000);
                    }
                };

                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        handleCheatDetection();
                    }
                };

                const handleBeforeUnload = (e) => {
                    if (isTestActive) {
                        e.preventDefault();
                        e.returnValue = 'B·∫°n ƒëang trong bu·ªïi thi. ƒê√≥ng tab s·∫Ω b·ªã ghi nh·∫≠n l√† gian l·∫≠n!';
                        return e.returnValue;
                    }
                };

                const handleBlur = (e) => {
                    if (isTestActive && e.target === window) {
                        handleCheatDetection();
                    }
                };

                if (isTestActive) {
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                    window.addEventListener('beforeunload', handleBeforeUnload);
                    window.addEventListener('blur', handleBlur);
                }

                return () => {
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                    window.removeEventListener('beforeunload', handleBeforeUnload);
                    window.removeEventListener('blur', handleBlur);
                };
            }, [isTestActive, student]);

            const start = () => {
                initAudio(); // K√≠ch ho·∫°t AudioContext qua t∆∞∆°ng t√°c ng∆∞·ªùi d√πng
                // D√ôNG 5 C√ÇU ƒê·∫¶U ƒê·ªÇ TEST
                const shuffled = [...questionDatabase].sort(() => Math.random() - 0.5);
                setQuestions(shuffled);
                setCurrentIdx(0);
                setScore(0);
                setSelected(null);
                setShowExpl(false);
                setCheatWarnings(0); // Reset c·∫£nh b√°o gian l·∫≠n
                setShowCheatAlert(false);
                setIsTestActive(true); // B·∫Øt ƒë·∫ßu theo d√µi ch·ªëng gian l·∫≠n
                setStartTime(Date.now()); // B·∫Øt ƒë·∫ßu ƒë·∫øm th·ªùi gian
                setElapsedTime(0);
                setGameState('playing');
            };

            const handleSelect = (idx) => {
                if (selected !== null) return;
                setSelected(idx);
                if (idx === questions[currentIdx].a) {
                    setScore(s => s + 10);
                    playCorrect();
                    confetti({ particleCount: 30, spread: 60, origin: { y: 0.8 } });
                } else {
                    playWrong();
                }
                setShowExpl(true);
            };

            const nextQuestion = () => {
                if (currentIdx < questions.length - 1) {
                    setCurrentIdx(prev => prev + 1);
                    setSelected(null);
                    setShowExpl(false);
                } else {
                    const finalScore = score + (questions[currentIdx] && selected === questions[currentIdx].a ? 10 : 0);
                    const finalTime = elapsedTime;
                    console.log('K·∫øt th√∫c b√†i thi - ƒêi·ªÉm:', finalScore, 'Th·ªùi gian:', finalTime);
                    saveQuizResult(finalScore, cheatWarnings, finalTime);
                    setIsTestActive(false); // K·∫øt th√∫c theo d√µi ch·ªëng gian l·∫≠n
                    
                    // Delay 2 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u r·ªìi m·ªõi l·∫•y b·∫£ng x·∫øp h·∫°ng
                    setTimeout(() => {
                        console.log('B·∫Øt ƒë·∫ßu l·∫•y b·∫£ng x·∫øp h·∫°ng...');
                        fetchLeaderboard(); // L·∫•y b·∫£ng x·∫øp h·∫°ng
                        setShowLeaderboard(true); // Hi·ªÉn th·ªã b·∫£ng x·∫øp h·∫°ng
                        setGameState('end');
                    }, 2000);
                }
            };

            const showSummary = () => setGameState('summary');

            const logout = () => {
                setStudent(null);
                localStorage.removeItem(STORAGE_KEY);
                setIsTestActive(false); // D·ª´ng theo d√µi khi ƒëƒÉng xu·∫•t
                setGameState('start');
            };

            const handleLogin = async (e) => {
                e?.preventDefault();
                setAuthError('');
                if (!authForm.fullName.trim() || !authForm.className.trim() || !authForm.password) {
                    setAuthError('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß h·ªç t√™n, l·ªõp v√† m·∫≠t kh·∫©u.');
                    return;
                }
                const supabase = getSupabase();
                if (!supabase) {
                    setAuthError('·ª®ng d·ª•ng ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Vui l√≤ng li√™n h·ªá gi√°o vi√™n.');
                    return;
                }
                setAuthLoading(true);
                try {
                    const pwHash = await hashPassword(authForm.password, authForm.className);
                    const { data, error } = await supabase.from('students').select('id, full_name, class_name')
                        .eq('full_name', authForm.fullName.trim()).eq('class_name', authForm.className.trim()).eq('password_hash', pwHash).single();
                    if (error || !data) {
                        setAuthError('Sai h·ªç t√™n, l·ªõp ho·∫∑c m·∫≠t kh·∫©u. N·∫øu ch∆∞a c√≥ t√†i kho·∫£n, h√£y ƒëƒÉng k√Ω.');
                        return;
                    }
                    const s = { id: data.id, full_name: data.full_name, class_name: data.class_name };
                    setStudent(s);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
                    setAuthForm({ fullName: '', className: '', password: '' });
                } catch (err) {
                    setAuthError('L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.');
                } finally { setAuthLoading(false); }
            };

            const handleRegister = async (e) => {
                e?.preventDefault();
                setAuthError('');
                if (!authForm.fullName.trim() || !authForm.className.trim() || !authForm.password) {
                    setAuthError('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß h·ªç t√™n, l·ªõp v√† m·∫≠t kh·∫©u.');
                    return;
                }
                if (authForm.password.length < 4) {
                    setAuthError('M·∫≠t kh·∫©u t·ªëi thi·ªÉu 4 k√Ω t·ª±.');
                    return;
                }
                const supabase = getSupabase();
                if (!supabase) {
                    setAuthError('·ª®ng d·ª•ng ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Vui l√≤ng li√™n h·ªá gi√°o vi√™n.');
                    return;
                }
                setAuthLoading(true);
                try {
                    const pwHash = await hashPassword(authForm.password, authForm.className);
                    const { data, error } = await supabase.from('students').insert(
                        { full_name: authForm.fullName.trim(), class_name: authForm.className.trim(), password_hash: pwHash }
                    ).select('id, full_name, class_name').single();
                    if (error) {
                        if (error.code === '23505') setAuthError('H·ªç t√™n + l·ªõp ƒë√£ t·ªìn t·∫°i. H√£y ƒëƒÉng nh·∫≠p v·ªõi m·∫≠t kh·∫©u ƒë√£ ƒëƒÉng k√Ω.');
                        else setAuthError('ƒêƒÉng k√Ω th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
                        return;
                    }
                    const s = { id: data.id, full_name: data.full_name, class_name: data.class_name };
                    setStudent(s);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
                    setAuthForm({ fullName: '', className: '', password: '' });
                } catch (err) {
                    setAuthError('L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.');
                } finally { setAuthLoading(false); }
            };

            const saveQuizResult = async (finalScore, warnings = 0, timeTaken = 0) => {
                const supabase = getSupabase();
                if (!supabase) {
                    console.error('Supabase ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o!');
                    return;
                }
                if (!student) {
                    console.error('Kh√¥ng c√≥ th√¥ng tin student!');
                    return;
                }

                try {
                    console.log('B·∫Øt ƒë·∫ßu l∆∞u k·∫øt qu·∫£:', { finalScore, warnings, timeTaken, student });
                    
                    const { data, error } = await supabase.from('quiz_attempts').insert({
                        student_id: student.id,
                        score: finalScore,
                        total_questions: 50,
                        attempt_number: 1, // T·∫°m th·ªùi hardcode
                        time_taken: timeTaken, // Th√™m th·ªùi gian l√†m b√†i
                        cheat_warnings: warnings // Th√™m s·ªë l·∫ßn c·∫£nh b√°o gian l·∫≠n
                    }).select();

                    if (error) {
                        console.error('L·ªói Supabase khi l∆∞u:', error);
                        throw error;
                    }
                    
                    console.log('L∆∞u k·∫øt qu·∫£ th√†nh c√¥ng:', data);
                } catch (err) {
                    console.error('Kh√¥ng l∆∞u ƒë∆∞·ª£c k·∫øt qu·∫£:', err);
                    console.error('Chi ti·∫øt l·ªói:', err.message);
                }
            };

            const handleAdminExport = async (e) => {
                e?.preventDefault();
                setAdminError('');
                if (adminPassword !== CONFIG.adminPassword) {
                    setAdminError('Sai m·∫≠t kh·∫©u gi√°o vi√™n.');
                    return;
                }
                const supabase = getSupabase();
                if (!supabase) {
                    setAdminError('Ch∆∞a c·∫•u h√¨nh Supabase. Kh√¥ng th·ªÉ xu·∫•t Excel.');
                    return;
                }
                setExportLoading(true);
                try {
    let summary = [];
    let error = null;
    
    // üëâ TH·ª¨ L·∫§Y T·ª™ VIEW QUIZ_SUMMARY TR∆Ø·ªöC
    try {
        const result = await supabase.from('quiz_summary').select('*');
        if (!result.error) {
            summary = result.data || [];
            console.log('L·∫•y d·ªØ li·ªáu t·ª´ quiz_summary th√†nh c√¥ng:', summary);
        } else {
            error = result.error;
            console.warn('Kh√¥ng l·∫•y ƒë∆∞·ª£c quiz_summary:', error);
        }
    } catch (e) {
        console.warn('L·ªói khi truy v·∫•n quiz_summary:', e);
    }
    
    // üëâ N·∫æU KH√îNG L·∫§Y ƒê∆Ø·ª¢C, T·ª∞ JOIN D·ªÆ LI·ªÜU
    if (!summary || summary.length === 0) {
        console.log('ƒêang t·ª± t·ªïng h·ª£p d·ªØ li·ªáu t·ª´ students v√† quiz_attempts...');
        
        // L·∫•y t·∫•t c·∫£ h·ªçc sinh k√®m b√†i l√†m
        const { data: students, error: sErr } = await supabase
            .from('students')
            .select('*, quiz_attempts(*)');
        
        if (sErr) throw sErr;
        
        // T·ª± t·ªïng h·ª£p d·ªØ li·ªáu
        summary = (students || []).map(student => {
            const attempts = student.quiz_attempts || [];
            const scores = attempts.map(a => a.score).filter(s => s != null);
            const warnings = attempts.map(a => a.cheat_warnings || 0);
            const dates = attempts.map(a => a.created_at).filter(d => d);
            
            return {
                "H·ªç v√† t√™n": student.full_name,
                "L·ªõp": student.class_name,
                "S·ªë l·∫ßn l√†m b√†i": attempts.length,
                "ƒêi·ªÉm cao nh·∫•t": scores.length > 0 ? Math.max(...scores) : 0,
                "ƒêi·ªÉm trung b√¨nh": scores.length > 0 
                    ? Number((scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2))
                    : 0,
                "T·ªïng c·∫£nh b√°o gian l·∫≠n": warnings.reduce((a, b) => a + b, 0),
                "C·∫£nh b√°o cao nh·∫•t": warnings.length > 0 ? Math.max(...warnings) : 0,
                "L·∫ßn ƒë·∫ßu l√†m": dates.length > 0 ? dates.sort()[0] : null,
                "L·∫ßn cu·ªëi l√†m": dates.length > 0 ? dates.sort().reverse()[0] : null
            };
        });
    }
    
    // üëâ T·∫†O ROWS CHO EXCEL
    const rows = (summary || []).map((r, i) => ({
        'STT': i + 1,
        'H·ªç v√† t√™n': r['H·ªç v√† t√™n'] || r.full_name || '',
        'L·ªõp': r['L·ªõp'] || r.class_name || '',
        'S·ªë l·∫ßn l√†m b√†i': r['S·ªë l·∫ßn l√†m b√†i'] || 0,
        'ƒêi·ªÉm cao nh·∫•t': r['ƒêi·ªÉm cao nh·∫•t'] || 0,
        'ƒêi·ªÉm trung b√¨nh': r['ƒêi·ªÉm trung b√¨nh'] || 0,
        'T·ªïng c·∫£nh b√°o gian l·∫≠n': r['T·ªïng c·∫£nh b√°o gian l·∫≠n'] || 0,
        'C·∫£nh b√°o cao nh·∫•t': r['C·∫£nh b√°o cao nh·∫•t'] || 0,
        'L·∫ßn ƒë·∫ßu l√†m': r['L·∫ßn ƒë·∫ßu l√†m'] 
            ? new Date(r['L·∫ßn ƒë·∫ßu l√†m']).toLocaleString('vi-VN') 
            : '',
        'L·∫ßn cu·ªëi l√†m': r['L·∫ßn cu·ªëi l√†m'] 
            ? new Date(r['L·∫ßn cu·ªëi l√†m']).toLocaleString('vi-VN') 
            : ''
    }));
    
    // üëâ XU·∫§T EXCEL (GI·ªÆ NGUY√äN)
    const ws = window.XLSX.utils.json_to_sheet(rows);
    const wb = window.XLSX.utils.book_new();
    window.XLSX.utils.book_append_sheet(wb, ws, 'K·∫øt qu·∫£ tr·∫Øc nghi·ªám');
    window.XLSX.writeFile(wb, 'ket-qua-trac-nghiem-vatly11-' + new Date().toISOString().slice(0,10) + '.xlsx');
    
    setAdminMode(false);
    setAdminPassword('');
    
} catch (err) {
    console.error('L·ªói xu·∫•t Excel:', err);
    setAdminError('L·ªói xu·∫•t file: ' + (err.message || 'Vui l√≤ng th·ª≠ l·∫°i'));
} finally {
    setExportLoading(false); }
            };

            // M√†n h√¨nh ƒëƒÉng nh·∫≠p / ƒëƒÉng k√Ω (khi ch∆∞a ƒëƒÉng nh·∫≠p)
            if (!student) {
                return (
                    <div className="flex items-center justify-center min-h-screen p-4">
                        <div className="glass-panel p-10 max-w-md w-full border-t-8 border-blue-500 shadow-2xl">
                            <div className="text-center mb-8">
                                <i className="fas fa-user-graduate text-5xl text-blue-500 mb-4"></i>
                                <h1 className="text-2xl font-black text-slate-800">ƒêƒÇNG NH·∫¨P</h1>
                                <p className="text-slate-500 text-sm mt-1">V·∫≠t L√≠ 11 - Ch∆∞∆°ng 3: ƒêi·ªán tr∆∞·ªùng</p>
                            </div>
                            <form onSubmit={authMode === 'login' ? handleLogin : handleRegister} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-slate-600 mb-1">H·ªç v√† t√™n</label>
                                    <input type="text" value={authForm.fullName} onChange={e => setAuthForm(f => ({ ...f, fullName: e.target.value }))}
                                        className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition"
                                        placeholder="Nguy·ªÖn VƒÉn A" autoComplete="name" />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-600 mb-1">L·ªõp</label>
                                    <input type="text" value={authForm.className} onChange={e => setAuthForm(f => ({ ...f, className: e.target.value }))}
                                        className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition"
                                        placeholder="11A1" autoComplete="off" />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-600 mb-1">M·∫≠t kh·∫©u</label>
                                    <input type="password" value={authForm.password} onChange={e => setAuthForm(f => ({ ...f, password: e.target.value }))}
                                        className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autoComplete={authMode === 'login' ? 'current-password' : 'new-password'} />
                                </div>
                                {authError && <div className="text-red-600 text-sm bg-red-50 p-3 rounded-xl">{authError}</div>}
                                <button type="submit" disabled={authLoading}
                                    className="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-blue-700 disabled:opacity-60 transition-all">
                                    {authLoading ? 'ƒêang x·ª≠ l√Ω...' : (authMode === 'login' ? 'ƒêƒÇNG NH·∫¨P' : 'ƒêƒÇNG K√ù')}
                                </button>
                            </form>
                            <button type="button" onClick={() => { setAuthMode(authMode === 'login' ? 'register' : 'login'); setAuthError(''); }}
                                className="w-full mt-4 text-blue-600 text-sm font-semibold hover:underline">
                                {authMode === 'login' ? 'Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay' : 'ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p'}
                            </button>
                            <button type="button" onClick={() => setAdminMode(true)}
                                className="w-full mt-6 pt-4 border-t border-slate-200 text-slate-400 text-xs hover:text-slate-600">
                                Gi√°o vi√™n: Xu·∫•t Excel k·∫øt qu·∫£
                            </button>
                        </div>
                        {adminMode && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => !exportLoading && setAdminMode(false)}>
                                <div className="glass-panel p-8 max-w-sm w-full border-t-8 border-slate-600" onClick={e => e.stopPropagation()}>
                                    <h3 className="text-lg font-black text-slate-800 mb-4">Xu·∫•t Excel k·∫øt qu·∫£</h3>
                                    <form onSubmit={handleAdminExport}>
                                        <input type="password" value={adminPassword} onChange={e => setAdminPassword(e.target.value)}
                                            className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 mb-4" placeholder="M·∫≠t kh·∫©u gi√°o vi√™n" />
                                        {adminError && <div className="text-red-600 text-sm mb-4">{adminError}</div>}
                                        <div className="flex gap-2">
                                            <button type="button" onClick={() => setAdminMode(false)} className="flex-1 py-3 rounded-xl border-2 border-slate-200">H·ªßy</button>
                                            <button type="submit" disabled={exportLoading} className="flex-1 py-3 rounded-xl bg-slate-700 text-white font-bold">
                                                {exportLoading ? 'ƒêang xu·∫•t...' : 'Xu·∫•t Excel'}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (gameState === 'start') return (
                <div className="flex items-center justify-center min-h-screen p-4">
                    <div className="glass-panel p-10 text-center max-w-md w-full border-t-8 border-blue-500 shadow-2xl relative">
                        <button onClick={logout} className="absolute top-4 right-4 p-2 rounded-lg text-slate-400 hover:bg-slate-100 hover:text-slate-600" title="ƒêƒÉng xu·∫•t">
                            <i className="fas fa-sign-out-alt"></i>
                        </button>
                        <div className="mb-2 py-2 px-4 rounded-xl bg-blue-50 inline-block text-blue-700 text-sm font-semibold">
                            <i className="fas fa-user mr-2"></i>{student.full_name} - {student.class_name}
                        </div>
                        <div className="mb-6 relative">
                            <i className="fas fa-bolt text-7xl text-yellow-400 animate-pulse"></i>
                        </div>
                        <h1 className="text-3xl font-black text-slate-800 mb-2">ƒê·∫†I CHI·∫æN V·∫¨T L√ç 11</h1>
                        <p className="text-slate-500 mb-8 font-semibold">Ch∆∞∆°ng 3: ƒêi·ªán tr∆∞·ªùng</p>
                        
                        <div className="bg-blue-50 p-4 rounded-xl text-left text-sm text-blue-700 mb-6 leading-relaxed">
                            <p><i className="fas fa-book mr-2"></i> √în t·∫≠p ki·∫øn th·ª©c tr∆∞·ªõc khi l√†m tr·∫Øc nghi·ªám ƒë·ªÉ ƒë·∫°t k·∫øt qu·∫£ t·ªët nh·∫•t.</p>
                            <p><i className="fas fa-music mr-2"></i> Tr√≤ ch∆°i s·∫Ω ph√°t ti·∫øng khi ch·ªçn ƒë√°p √°n.</p>
                            <p><i className="fas fa-square-root-variable mr-2"></i> C√¥ng th·ª©c hi·ªÉn th·ªã d·∫°ng LaTeX s·∫Øc n√©t.</p>
                        </div>

                        <button onClick={showSummary} className="w-full bg-slate-100 border-2 border-blue-500 text-blue-600 py-4 rounded-2xl font-bold text-lg shadow-sm hover:bg-blue-50 hover:border-blue-600 transition-all active:scale-95 mb-4">
                            <i className="fas fa-book-open mr-2"></i> √îN T·∫¨P KI·∫æN TH·ª®C CH∆Ø∆†NG 3
                        </button>
                        <button onClick={start} className="w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xl shadow-lg hover:bg-blue-700 hover:-translate-y-1 transition-all active:scale-95">
                            B·∫ÆT ƒê·∫¶U NGAY
                        </button>
                        <button type="button" onClick={() => setAdminMode(true)}
                            className="w-full mt-6 pt-4 border-t border-slate-200 text-slate-400 text-xs hover:text-slate-600">
                            Gi√°o vi√™n: Xu·∫•t Excel k·∫øt qu·∫£
                        </button>
                    </div>
                    {adminMode && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => !exportLoading && setAdminMode(false)}>
                            <div className="glass-panel p-8 max-w-sm w-full border-t-8 border-slate-600" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-black text-slate-800 mb-4">Xu·∫•t Excel k·∫øt qu·∫£</h3>
                                <form onSubmit={handleAdminExport}>
                                    <input type="password" value={adminPassword} onChange={e => setAdminPassword(e.target.value)}
                                        className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 mb-4" placeholder="M·∫≠t kh·∫©u gi√°o vi√™n" />
                                    {adminError && <div className="text-red-600 text-sm mb-4">{adminError}</div>}
                                    <div className="flex gap-2">
                                        <button type="button" onClick={() => setAdminMode(false)} className="flex-1 py-3 rounded-xl border-2 border-slate-200">H·ªßy</button>
                                        <button type="submit" disabled={exportLoading} className="flex-1 py-3 rounded-xl bg-slate-700 text-white font-bold">
                                            {exportLoading ? 'ƒêang xu·∫•t...' : 'Xu·∫•t Excel'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );

            if (gameState === 'summary') return (
                <div className="max-w-3xl mx-auto px-4 py-10 tex2jax_process">
                    <div className="glass-panel p-8 md:p-10 mb-6 border-t-8 border-blue-500 shadow-2xl">
                        <div className="flex items-center justify-between mb-8">
                            <div>
                                <h1 className="text-2xl md:text-3xl font-black text-slate-800">T√ìM T·∫ÆT KI·∫æN TH·ª®C CH∆Ø∆†NG 3</h1>
                                <p className="text-slate-500 font-semibold mt-1">ƒêi·ªán tr∆∞·ªùng - √în t·∫≠p tr∆∞·ªõc khi l√†m tr·∫Øc nghi·ªám</p>
                            </div>
                            <button onClick={() => setGameState('start')} className="p-3 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-600 transition-all">
                                <i className="fas fa-arrow-left"></i>
                            </button>
                        </div>

                        <div className="space-y-8">
                            {/* B√†i 11: ƒê·ªãnh lu·∫≠t Coulomb */}
                            <div className="bg-blue-50/50 border-2 border-blue-100 rounded-2xl p-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black">11</div>
                                    <h2 className="text-xl font-black text-slate-800">B√†i 11: ƒê·ªãnh lu·∫≠t Coulomb</h2>
                                </div>
                                <ul className="space-y-3 text-slate-700 leading-relaxed">
                                    <li><strong>‚Ä¢ L·ª±c t∆∞∆°ng t√°c:</strong> {'$F = k \\frac{|q_1 q_2|}{\\varepsilon r^2}$'} v·ªõi {'$k = 9 \\cdot 10^9 \\, N \\cdot m^2/C^2$'}</li>
                                    <li><strong>‚Ä¢ C√πng d·∫•u ƒë·∫©y nhau</strong>, tr√°i d·∫•u h√∫t nhau. {'$F$'} t·ªâ l·ªá ngh·ªãch v·ªõi {'$r^2$'}.</li>
                                    <li><strong>‚Ä¢ H·∫±ng s·ªë ƒëi·ªán m√¥i:</strong> Ch√¢n kh√¥ng {'$\\varepsilon = 1$'}. Trong ƒëi·ªán m√¥i l·ª±c gi·∫£m {'$\\varepsilon$'} l·∫ßn.</li>
                                    <li><strong>‚Ä¢ ƒêi·ªán t√≠ch nguy√™n t·ªë:</strong> {'$e = 1,6 \\cdot 10^{-19} C$'}. Electron mang {'$-e$'}.</li>
                                    <li><strong>‚Ä¢ ƒê∆°n v·ªã k:</strong> {'$N \\cdot m^2 / C^2$'}</li>
                                </ul>
                            </div>

                            {/* B√†i 12: ƒêi·ªán tr∆∞·ªùng */}
                            <div className="bg-blue-50/50 border-2 border-blue-100 rounded-2xl p-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black">12</div>
                                    <h2 className="text-xl font-black text-slate-800">B√†i 12: ƒêi·ªán tr∆∞·ªùng</h2>
                                </div>
                                <ul className="space-y-3 text-slate-700 leading-relaxed">
                                    <li><strong>‚Ä¢ C∆∞·ªùng ƒë·ªô ƒëi·ªán tr∆∞·ªùng:</strong> {'$\\vec{E} = \\vec{F}/q$'} ho·∫∑c {'$E = k \\frac{|Q|}{r^2}$'} (ƒëi·ªán t√≠ch ƒëi·ªÉm)</li>
                                    <li><strong>‚Ä¢ ƒê∆°n v·ªã:</strong> {'$V/m$'}. L·ª±c ƒëi·ªán: {'$F = qE$'}.</li>
                                    <li><strong>‚Ä¢ ƒê∆∞·ªùng s·ª©c ƒëi·ªán:</strong> ƒêi ra t·ª´ ƒëi·ªán t√≠ch d∆∞∆°ng, ƒëi v√†o ƒëi·ªán t√≠ch √¢m. Kh√¥ng c·∫Øt nhau.</li>
                                    <li><strong>‚Ä¢ ƒêi·ªán tr∆∞·ªùng ƒë·ªÅu:</strong> {'$\\vec{E}$'} kh√¥ng ƒë·ªïi, ƒë∆∞·ªùng s·ª©c song song c√°ch ƒë·ªÅu.</li>
                                    <li><strong>‚Ä¢ Nguy√™n l√≠ ch·ªìng ch·∫•t:</strong> {'$\\vec{E} = \\vec{E_1} + \\vec{E_2} + ...$'}</li>
                                </ul>
                            </div>

                            {/* B√†i 13: ƒêi·ªán th·∫ø - Th·∫ø nƒÉng */}
                            <div className="bg-blue-50/50 border-2 border-blue-100 rounded-2xl p-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black">13</div>
                                    <h2 className="text-xl font-black text-slate-800">B√†i 13: ƒêi·ªán th·∫ø - Th·∫ø nƒÉng</h2>
                                </div>
                                <ul className="space-y-3 text-slate-700 leading-relaxed">
                                    <li><strong>‚Ä¢ C√¥ng l·ª±c ƒëi·ªán (ƒëi·ªán tr∆∞·ªùng ƒë·ªÅu):</strong> {'$A = qEd$'} v·ªõi {'$d$'} l√† h√¨nh chi·∫øu qu√£ng ƒë∆∞·ªùng l√™n ph∆∞∆°ng {'$\\vec{E}$'}.</li>
                                    <li><strong>‚Ä¢ C√¥ng t·ªïng qu√°t:</strong> {'$A = q(V_M - V_N) = qU_{MN}$'}. Kh√¥ng ph·ª• thu·ªôc h√¨nh d·∫°ng qu·ªπ ƒë·∫°o.</li>
                                    <li><strong>‚Ä¢ Hi·ªáu ƒëi·ªán th·∫ø:</strong> {'$U_{MN} = V_M - V_N$'}. Li√™n h·ªá: {'$E = U/d$'} (ƒëi·ªán tr∆∞·ªùng ƒë·ªÅu).</li>
                                    <li><strong>‚Ä¢ ƒêi·ªán th·∫ø ƒë·∫∑c tr∆∞ng</strong> cho kh·∫£ nƒÉng sinh c√¥ng. ƒê∆°n v·ªã: V√¥n (V).</li>
                                    <li><strong>‚Ä¢ Chi·ªÅu {'$\\vec{E}$'}:</strong> T·ª´ n∆°i ƒëi·ªán th·∫ø cao sang th·∫•p. Vu√¥ng g√≥c ƒë∆∞·ªùng s·ª©c th√¨ {'$A = 0$'}.</li>
                                </ul>
                            </div>

                            {/* B√†i 14: T·ª• ƒëi·ªán */}
                            <div className="bg-blue-50/50 border-2 border-blue-100 rounded-2xl p-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black">14</div>
                                    <h2 className="text-xl font-black text-slate-800">B√†i 14: T·ª• ƒëi·ªán</h2>
                                </div>
                                <ul className="space-y-3 text-slate-700 leading-relaxed">
                                    <li><strong>‚Ä¢ ƒêi·ªán dung:</strong> {'$C = Q/U$'}. ƒê∆°n v·ªã Fara: {'$1 F = 1 C/V$'}.</li>
                                    <li><strong>‚Ä¢ NƒÉng l∆∞·ª£ng t·ª•:</strong> {'$W = \\frac{1}{2}CU^2 = \\frac{1}{2}QU$'}. NƒÉng l∆∞·ª£ng ƒëi·ªán tr∆∞·ªùng.</li>
                                    <li><strong>‚Ä¢ T·ª• ph·∫≥ng:</strong> {'$C = \\frac{\\varepsilon S}{4\\pi kd}$'}. C tƒÉng khi gi·∫£m {'$d$'}, tƒÉng {'$S$'}.</li>
                                    <li><strong>‚Ä¢ Gh√©p song song:</strong> {'$C = C_1 + C_2$'}. Gh√©p n·ªëi ti·∫øp: {'$\\frac{1}{C} = \\frac{1}{C_1} + \\frac{1}{C_2}$'}.</li>
                                    <li><strong>‚Ä¢ Ng·∫Øt t·ª• kh·ªèi ngu·ªìn:</strong> {'$Q$'} kh√¥ng ƒë·ªïi. N·ªëi ngu·ªìn: {'$U$'} kh√¥ng ƒë·ªïi.</li>
                                </ul>
                            </div>

                            {/* B·ªï sung t·ªïng h·ª£p */}
                            <div className="bg-slate-50 border-2 border-slate-200 rounded-2xl p-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-10 h-10 bg-slate-700 rounded-xl flex items-center justify-center text-white font-black"><i className="fas fa-lightbulb text-sm"></i></div>
                                    <h2 className="text-xl font-black text-slate-800">Ki·∫øn th·ª©c b·ªï sung</h2>
                                </div>
                                <ul className="space-y-2 text-slate-700 leading-relaxed text-sm">
                                    <li>‚Ä¢ Nguy√™n t·ª≠ trung h√≤a: s·ªë proton = s·ªë electron.</li>
                                    <li>‚Ä¢ V·∫≠t d·∫´n c√¢n b·∫±ng: {'$E = 0$'} b√™n trong.</li>
                                    <li>‚Ä¢ D√≤ng ƒëi·ªán trong kim lo·∫°i: d·ªãch chuy·ªÉn c√≥ h∆∞·ªõng c·ªßa electron t·ª± do.</li>
                                    <li>‚Ä¢ Nhi·ªÖm ƒëi·ªán ti·∫øp x√∫c: ƒëi·ªán t√≠ch chia ƒë·ªÅu cho hai v·∫≠t gi·ªëng nhau.</li>
                                </ul>
                            </div>
                        </div>

                        <button onClick={start} className="mt-8 w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xl shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all flex items-center justify-center group">
                            B·∫ÆT ƒê·∫¶U L√ÄM TR·∫ÆC NGHI·ªÜM
                            <i className="fas fa-chevron-right ml-3 group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                </div>
            );

            if (gameState === 'end') {
                const finalScore = score + (selected !== null && questions[currentIdx] && selected === questions[currentIdx].a ? 10 : 0);
                
                // N·∫øu ƒëang hi·ªÉn th·ªã b·∫£ng x·∫øp h·∫°ng
                if (showLeaderboard) {
                    // T√¨m x·∫øp h·∫°ng c·ªßa user hi·ªán t·∫°i m·ªôt c√°ch tr·ª±c ti·∫øp h∆°n
                    const currentUserRank = leaderboard.find(item => 
                        student && 
                        item.full_name === student.full_name && 
                        item.class_name === student.class_name
                        
                    );
                    
                    console.log('User hi·ªán t·∫°i:', student);
                    console.log('Final score:', finalScore);
                    console.log('Current user rank:', currentUserRank);
                    
                    return (
                        <div className="max-w-4xl mx-auto px-4 py-10">
                            <div className="glass-panel p-8 md:p-10 border-t-8 border-yellow-500 shadow-2xl">
                                <div className="text-center mb-8">
                                    <i className="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                                    <h1 className="text-3xl font-black text-slate-800 mb-2">B·∫¢NG X·∫æP H·∫†NG</h1>
                                    <p className="text-slate-500">V·∫≠t L√≠ 11 - Ch∆∞∆°ng 3: ƒêi·ªán tr∆∞·ªùng</p>
                                </div>

                                {/* K·∫øt qu·∫£ c·ªßa b·∫°n */}
                                <div className="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6 mb-8">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <h3 className="font-bold text-blue-800 text-lg mb-2">K·∫øt qu·∫£ c·ªßa b·∫°n</h3>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                <div>
                                                    <div className="text-2xl font-black text-blue-600">{finalScore}</div>
                                                    <div className="text-sm text-blue-600">ƒêi·ªÉm</div>
                                                </div>
                                                <div>
                                                    <div className="text-2xl font-black text-blue-600">{formatTime(elapsedTime)}</div>
                                                    <div className="text-sm text-blue-600">Th·ªùi gian</div>
                                                </div>
                                                <div>
                                                    <div className="text-2xl font-black text-blue-600">#{currentUserRank?.rank_position || '-'}</div>
                                                    <div className="text-sm text-blue-600">X·∫øp h·∫°ng</div>
                                                </div>
                                                <div>
                                                    <div className="text-2xl font-black text-red-600">{cheatWarnings}</div>
                                                    <div className="text-sm text-red-600">C·∫£nh b√°o</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* B·∫£ng x·∫øp h·∫°ng */}
                                <div className="bg-white rounded-2xl overflow-hidden shadow-lg">
                                    <div className="bg-gradient-to-r from-yellow-500 to-orange-500 text-white p-4">
                                        <h3 className="font-bold text-lg">Top 50 Th√≠ Sinh</h3>
                                    </div>
                                    {loadingLeaderboard ? (
                                        <div className="p-8 text-center">
                                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                            <p className="mt-2 text-slate-600">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...</p>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead className="bg-slate-50 border-b">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left text-sm font-bold text-slate-700">#</th>
                                                        <th className="px-4 py-3 text-left text-sm font-bold text-slate-700">H·ªç v√† t√™n</th>
                                                        <th className="px-4 py-3 text-left text-sm font-bold text-slate-700">L·ªõp</th>
                                                        <th className="px-4 py-3 text-center text-sm font-bold text-slate-700">ƒêi·ªÉm</th>
                                                        <th className="px-4 py-3 text-center text-sm font-bold text-slate-700">Th·ªùi gian</th>
                                                        <th className="px-4 py-3 text-center text-sm font-bold text-slate-700">C·∫£nh b√°o</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {leaderboard.map((item, index) => {
                                                        // Logic linh ho·∫°t h∆°n ƒë·ªÉ t√¨m user hi·ªán t·∫°i
                                                        const isCurrentUser = student && 
                                                                           item.full_name === student.full_name && 
                                                                           item.class_name === student.class_name &&
                                                                           Math.abs(item.score - finalScore) < 0.01; // Cho ph√©p sai s·ªë nh·ªè
                                                        return (
                                                            <tr key={index} className={`border-b hover:bg-slate-50 ${isCurrentUser ? 'bg-blue-50 font-bold' : ''}`}>
                                                                <td className="px-4 py-3">
                                                                    {item.rank_position <= 3 ? (
                                                                        <span className={`inline-flex items-center justify-center w-8 h-8 rounded-full font-bold text-white ${
                                                                            item.rank_position === 1 ? 'bg-yellow-500' : 
                                                                            item.rank_position === 2 ? 'bg-gray-400' : 'bg-orange-600'
                                                                        }`}>
                                                                            {item.rank_position}
                                                                        </span>
                                                                    ) : (
                                                                        <span className="text-slate-600 font-medium">{item.rank_position}</span>
                                                                    )}
                                                                </td>
                                                                <td className="px-4 py-3">
                                                                    <div className="flex items-center">
                                                                        {isCurrentUser && <i className="fas fa-star text-yellow-500 mr-2"></i>}
                                                                        <span className={isCurrentUser ? 'text-blue-700' : 'text-slate-700'}>
                                                                            {item.full_name}
                                                                        </span>
                                                                    </div>
                                                                </td>
                                                                <td className="px-4 py-3 text-slate-600">{item.class_name}</td>
                                                                <td className="px-4 py-3 text-center">
                                                                    <span className={`font-bold ${isCurrentUser ? 'text-blue-700 text-lg' : 'text-slate-700'}`}>
                                                                        {item.score}
                                                                    </span>
                                                                </td>
                                                                <td className="px-4 py-3 text-center text-slate-600">
                                                                    {formatTime(item.time_taken || 0)}
                                                                </td>
                                                                <td className="px-4 py-3 text-center">
                                                                    {item.cheat_warnings > 0 ? (
                                                                        <span className="text-red-600 font-bold">{item.cheat_warnings}</span>
                                                                    ) : (
                                                                        <span className="text-green-600">0</span>
                                                                    )}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-4 mt-8">
                                    <button onClick={start} className="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-all">
                                        <i className="fas fa-redo mr-2"></i>L√†m l·∫°i
                                    </button>
                                    <button onClick={() => { setShowLeaderboard(false); setGameState('start'); }} className="flex-1 bg-slate-100 text-slate-600 py-4 rounded-xl font-semibold hover:bg-slate-200">
                                        <i className="fas fa-home mr-2"></i>V·ªÅ trang ch·ªß
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }

                // M√†n h√¨nh k·∫øt qu·∫£ c≈© (n·∫øu kh√¥ng hi·ªÉn th·ªã b·∫£ng x·∫øp h·∫°ng)
                return (
                    <div className="flex items-center justify-center min-h-screen p-4">
                        <div className="glass-panel p-10 text-center max-w-md w-full shadow-2xl border-t-8 border-blue-500">
                            <i className="fas fa-trophy text-6xl text-yellow-500 mb-6"></i>
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">HO√ÄN TH√ÄNH TH·ª¨ TH√ÅCH</h2>
                            <div className="text-7xl font-black text-blue-600 mb-4">{finalScore}</div>
                            <p className="text-slate-400 font-bold mb-2">ƒêI·ªÇM S·ªê C·ª¶A B·∫†N</p>
                            
                            {/* Hi·ªÉn th·ªã c·∫£nh b√°o gian l·∫≠n */}
                            {cheatWarnings > 0 && (
                                <div className="mb-4 p-4 bg-red-50 border-2 border-red-200 rounded-xl">
                                    <div className="text-red-600 font-bold mb-2">
                                        <i className="fas fa-exclamation-triangle mr-2"></i>
                                        C·∫¢NH B√ÅO GIAN L·∫¨N
                                    </div>
                                    <div className="text-red-500 text-sm">
                                        B·∫°n ƒë√£ b·ªã ghi nh·∫≠n {cheatWarnings} l·∫ßn vi ph·∫°m quy ch·∫ø thi
                                    </div>
                                </div>
                            )}
                            
                            <p className="text-slate-400 text-sm mb-6">K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c l∆∞u. Gi√°o vi√™n c√≥ th·ªÉ xu·∫•t Excel ƒë·ªÉ xem.</p>
                            <button onClick={start} className="w-full bg-slate-800 text-white py-4 rounded-xl font-bold hover:bg-black transition-all mb-3">
                                TH·ª¨ TH√ÅCH L·∫†I
                            </button>
                            <button onClick={() => setGameState('start')} className="w-full bg-slate-100 text-slate-600 py-3 rounded-xl font-semibold hover:bg-slate-200">
                                V·ªÄ TRANG CH·ª¶
                            </button>
                        </div>
                    </div>
                );
            }

            const q = questions[currentIdx];

            return (
                <div className="max-w-2xl mx-auto px-4 py-10 tex2jax_process">
                    {/* C·∫£nh b√°o gian l·∫≠n */}
                    {showCheatAlert && (
                        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-red-600 text-white px-6 py-4 rounded-xl shadow-2xl border-2 border-red-700 animate-pulse">
                            <div className="flex items-center gap-3">
                                <i className="fas fa-exclamation-triangle text-2xl"></i>
                                <div>
                                    <div className="font-bold text-lg">C·∫¢NH B√ÅO GIAN L·∫¨N!</div>
                                    <div className="text-sm">B·∫°n ƒë√£ r·ªùi kh·ªèi tab thi. L·∫ßn {cheatWarnings}</div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-6">
                        <div className="bg-white px-4 py-2 rounded-xl shadow-sm border font-bold text-slate-600">
                            C√¢u {currentIdx + 1}/50
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="bg-green-100 text-green-700 px-3 py-2 rounded-xl border border-green-200 font-bold text-sm">
                                <i className="fas fa-clock mr-1"></i>
                                {formatTime(elapsedTime)}
                            </div>
                            {cheatWarnings > 0 && (
                                <div className="bg-red-100 text-red-600 px-3 py-2 rounded-xl border border-red-200 font-bold text-sm">
                                    <i className="fas fa-exclamation-triangle mr-1"></i>
                                    {cheatWarnings} c·∫£nh b√°o
                                </div>
                            )}
                            <div className="bg-blue-600 px-6 py-2 rounded-xl shadow-md text-white font-black">
                                <i className="fas fa-star mr-2 text-yellow-300"></i> {score}
                            </div>
                        </div>
                    </div>

                    <div className="w-full bg-slate-200 h-2 rounded-full mb-8 overflow-hidden">
                        <div className="bg-blue-500 h-full rounded-full transition-all duration-300" style={{width: `${((currentIdx + 1)/50)*100}%`}}></div>
                    </div>

                    <div className="glass-panel p-8 md:p-12 mb-6">
                        <h2 className="text-xl md:text-2xl font-extrabold text-slate-800 mb-10 leading-snug">
                            {q.q}
                        </h2>

                        <div className="grid gap-4">
                            {q.options.map((opt, i) => {
                                let style = "border-slate-100 text-slate-700 hover:border-blue-200 hover:bg-blue-50";
                                if (selected !== null) {
                                    if (i === q.a) style = "border-green-500 bg-green-50 text-green-700 font-bold ring-2 ring-green-100";
                                    else if (i === selected) style = "border-red-500 bg-red-50 text-red-700 font-bold ring-2 ring-red-100";
                                    else style = "border-transparent text-slate-300 opacity-50";
                                }
                                return (
                                    <button 
                                        key={i}
                                        disabled={selected !== null}
                                        onClick={() => handleSelect(i)}
                                        className={`btn-opt p-5 rounded-2xl border-2 text-left flex items-center shadow-sm ${style}`}
                                    >
                                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center mr-4 font-black transition-colors ${selected === null ? 'bg-slate-100 text-slate-500' : (i===q.a ? 'bg-green-500 text-white' : 'bg-red-500 text-white')}`}>
                                            {String.fromCharCode(65+i)}
                                        </div>
                                        <span className="text-lg">{opt}</span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {showExpl && (
                        <div className="explanation-anim bg-white border-2 border-blue-500 p-8 rounded-3xl shadow-xl mb-12">
                            <div className="flex items-center mb-4 text-blue-600 font-black uppercase tracking-widest text-sm">
                                <div className="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <i className="fas fa-brain text-xs"></i>
                                </div>
                                Ph√¢n t√≠ch v·∫≠t l√≠
                            </div>
                            <div className="text-lg text-slate-700 leading-relaxed bg-slate-50 p-5 rounded-2xl border border-slate-100 italic">
                                {q.expl}
                            </div>
                            <button 
                                onClick={nextQuestion}
                                className="mt-8 w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all flex items-center justify-center group"
                            >
                                {currentIdx === 49 ? 'XEM K·∫æT QU·∫¢' : 'C√ÇU TI·∫æP THEO'}
                                <i className="fas fa-chevron-right ml-3 group-hover:translate-x-1 transition-transform"></i>
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
