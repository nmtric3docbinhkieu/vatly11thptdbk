<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vật Lí 11 - 50 Câu Hỏi Có Âm Thanh & MathJax</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$']],
                processEscapes: true
            },
            options: { processHtmlClass: 'tex2jax_process' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Nunito', sans-serif; background: #f1f5f9; }
        .glass-panel { background: white; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .btn-opt { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-opt:active { transform: scale(0.98); }
        .explanation-anim { animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // ========== CẤU HÌNH - Thay bằng giá trị của bạn khi deploy ==========
        const CONFIG = {
            supabaseUrl: 'https://bxffaxcimeturttxqrme.supabase.co',  // Thay YOUR_PROJECT bằng ID dự án Supabase
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4ZmZheGNpbWV0dXJ0dHhxcm1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MDk1MzQsImV4cCI6MjA4NTk4NTUzNH0.uU3H707Qjfd2X4iQN3K9KKhsvNZkYn8v8zB_5lthzr0',            // Lấy từ Settings > API > anon public
            adminPassword: 'teacher123'                       // Mật khẩu giáo viên để xuất Excel
        };

        // Supabase client (chỉ khởi tạo khi đã cấu hình)
        const getSupabase = () => {
            if (!CONFIG.supabaseUrl || CONFIG.supabaseUrl.includes('YOUR_PROJECT')) return null;
            return window.supabase?.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey) || null;
        };

        // Mã hóa mật khẩu (SHA-256 với salt)
        const hashPassword = async (password, salt) => {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + salt + 'vatly11');
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
        };

        const STORAGE_KEY = 'vatly11_student';

        // Âm thanh tự tạo bằng Web Audio API
        const useSound = () => {
            const audioCtx = useRef(null);

            const initAudio = () => {
                if (!audioCtx.current) {
                    audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.current.state === 'suspended') {
                    audioCtx.current.resume();
                }
            };

            const playCorrect = () => {
                initAudio();
                const osc = audioCtx.current.createOscillator();
                const gain = audioCtx.current.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, audioCtx.current.currentTime); // C5
                osc.frequency.exponentialRampToValueAtTime(880, audioCtx.current.currentTime + 0.1); // A5
                gain.gain.setValueAtTime(0.1, audioCtx.current.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.current.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(audioCtx.current.destination);
                osc.start();
                osc.stop(audioCtx.current.currentTime + 0.3);
            };

            const playWrong = () => {
                initAudio();
                const osc = audioCtx.current.createOscillator();
                const gain = audioCtx.current.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.current.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.current.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, audioCtx.current.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, audioCtx.current.currentTime + 0.2);
                osc.connect(gain);
                gain.connect(audioCtx.current.destination);
                osc.start();
                osc.stop(audioCtx.current.currentTime + 0.2);
            };

            return { playCorrect, playWrong, initAudio };
        };

        const questionDatabase = [
            // Bài 11: Định luật Coulomb
            { q: "Lực tương tác tĩnh điện giữa hai điện tích điểm tỉ lệ nghịch với:", options: ["Tích độ lớn hai điện tích", "Khoảng cách giữa hai điện tích", "Bình phương khoảng cách giữa hai điện tích", "Hằng số điện môi"], a: 2, expl: "Theo định luật Coulomb: $F = k \\frac{|q_1q_2|}{\\varepsilon r^2}$. Lực $F$ tỉ lệ nghịch với bình phương khoảng cách $r^2$." },
            { q: "Hằng số điện môi của chân không bằng:", options: ["0", "1", "2", "8,85.10^-12"], a: 1, expl: "Trong chân không, $\\varepsilon = 1$. Đây là giá trị nhỏ nhất của hằng số điện môi." },
            { q: "Đơn vị của hằng số $k$ trong công thức Coulomb là:", options: ["$C^2/N.m^2$", "$N.m^2/C^2$", "$V/m$", "$N/C$"], a: 1, expl: "Từ công thức $F = k \\frac{q^2}{r^2} \\Rightarrow k = \\frac{F \\cdot r^2}{q^2}$ nên đơn vị là $N \\cdot m^2 / C^2$." },
            { q: "Nếu đồng thời tăng độ lớn mỗi điện tích lên 2 lần và giảm khoảng cách đi 2 lần thì lực Coulomb:", options: ["Tăng 4 lần", "Tăng 8 lần", "Tăng 16 lần", "Không đổi"], a: 2, expl: "Tử số tăng $2 \\times 2 = 4$. Mẫu số giảm $2^2 = 4$. Tổng cộng lực tăng $4 \\times 4 = 16$ lần." },
            { q: "Hạt mang điện tích nguyên tố âm là:", options: ["Proton", "Nơtron", "Electron", "Hạt nhân"], a: 2, expl: "Electron mang điện tích $-1,6 \\cdot 10^{-19} C$." },
            { q: "Lực tương tác giữa hai điện tích điểm $2 \\mu C$ và $-2 \\mu C$ cách nhau 10cm trong chân không là:", options: ["3,6 N", "0,36 N", "36 N", "0,036 N"], a: 1, expl: "$F = 9 \\cdot 10^9 \\frac{|2 \\cdot 10^{-6} \\cdot (-2 \\cdot 10^{-6})|}{0,1^2} = 0,36 N$." },
            { q: "Trong các chất sau, chất nào dẫn điện tốt nhất?", options: ["Nước tinh khiết", "Thủy tinh", "Đồng", "Gỗ khô"], a: 2, expl: "Đồng là kim loại có nhiều electron tự do nên dẫn điện tốt." },
            { q: "Đưa hai điện tích từ chân không vào môi trường có $\\varepsilon = 2$ thì lực tương tác:", options: ["Tăng 2 lần", "Giảm 2 lần", "Giảm 4 lần", "Không đổi"], a: 1, expl: "Lực trong điện môi giảm $\\varepsilon$ lần so với chân không." },
            { q: "Khối lượng của một electron xấp xỉ bằng:", options: ["$1,67 \\cdot 10^{-27} kg$", "$9,1 \\cdot 10^{-31} kg$", "$1,6 \\cdot 10^{-19} kg$", "$9,1 \\cdot 10^{-19} kg$"], a: 1, expl: "$m_e \\approx 9,1 \\cdot 10^{-31} kg$." },
            { q: "Hai điện tích điểm cùng dấu khi đặt gần nhau sẽ:", options: ["Hút nhau", "Đẩy nhau", "Không tương tác", "Lúc hút lúc đẩy"], a: 1, expl: "Cùng dấu đẩy nhau, trái dấu hút nhau." },

            // Bài 12: Điện trường
            { q: "Vectơ cường độ điện trường $\\vec{E}$ tại một điểm đặc trưng cho điện trường về phương diện:", options: ["Năng lượng", "Tác dụng lực", "Tốc độ", "Độ cao"], a: 1, expl: "$\\vec{E} = \\vec{F}/q$ đặc trưng cho khả năng tác dụng lực của điện trường." },
            { q: "Đơn vị của cường độ điện trường là:", options: ["Vôn (V)", "Jun (J)", "Vôn trên mét (V/m)", "Ni-tơn (N)"], a: 2, expl: "Đơn vị chuẩn là $V/m$." },
            { q: "Đường sức điện của một điện tích điểm âm có chiều:", options: ["Hướng ra xa nó", "Hướng về phía nó", "Song song với nhau", "Đường tròn"], a: 1, expl: "Đường sức điện đi vào điện tích âm." },
            { q: "Điện trường đều có các đường sức điện là:", options: ["Các đường cong", "Các đường thẳng song song cách đều", "Các đường tròn", "Các đường thẳng đồng quy"], a: 1, expl: "Trong điện trường đều, $\\vec{E}$ tại mọi điểm là như nhau." },
            { q: "Công thức $E = k \\frac{|Q|}{r^2}$ dùng để tính cường độ điện trường của:", options: ["Vật dẫn bất kì", "Điện tích điểm", "Tụ điện", "Dòng điện"], a: 1, expl: "Đây là công thức cho điện tích điểm gây ra tại điểm cách nó khoảng r." },
            { q: "Tại một điểm trong điện trường, nếu ta tăng độ lớn điện tích thử q lên 2 lần thì E tại đó:", options: ["Tăng 2 lần", "Giảm 2 lần", "Không đổi", "Tăng 4 lần"], a: 2, expl: "Cường độ điện trường E chỉ phụ thuộc nguồn gây ra nó, không phụ thuộc điện tích thử q." },
            { q: "Nguyên lí chồng chất điện trường giúp ta tính E tổng hợp bằng cách:", options: ["Cộng đại số các độ lớn", "Cộng vectơ các E thành phần", "Lấy hiệu các độ lớn", "Nhân các độ lớn"], a: 1, expl: "$\\vec{E} = \\vec{E_1} + \\vec{E_2} + ...$" },
            { q: "Đường sức điện không bao giờ:", options: ["Đi ra từ điện tích dương", "Cắt nhau", "Tận cùng ở vô cực", "Có hình dạng đường thẳng"], a: 1, expl: "Các đường sức điện không bao giờ giao nhau tại một điểm." },
            { q: "Cường độ điện trường $E = 1000 V/m$, lực điện tác dụng lên $q = 1 \\mu C$ là:", options: ["$10^{-3} N$", "$10^{-6} N$", "$1 N$", "$1000 N$"], a: 0, expl: "$F = qE = 10^{-6} \\cdot 1000 = 10^{-3} N$." },
            { q: "Trong điện trường đều, lực điện tác dụng lên một điện tích q là:", options: ["Thay đổi theo vị trí", "Luôn bằng 0", "Không đổi về hướng và độ lớn", "Tỉ lệ với khoảng cách"], a: 2, expl: "Vì $\\vec{E}$ không đổi nên $\\vec{F} = q\\vec{E}$ cũng không đổi." },

            // Bài 13: Điện thế - Thế năng
            { q: "Công của lực điện trường khi q di chuyển trong điện trường đều là $A = qEd$. d là:", options: ["Quãng đường đi", "Hình chiếu quãng đường lên phương đường sức", "Khoảng cách đầu cuối", "Bán kính quỹ đạo"], a: 1, expl: "d là hình chiếu của vectơ dịch chuyển lên phương của vectơ $\\vec{E}$." },
            { q: "Điện thế $V_M$ đặc trưng cho điện trường về mặt:", options: ["Tác dụng lực", "Năng lượng (khả năng sinh công)", "Độ mạnh yếu", "Chiều của đường sức"], a: 1, expl: "Điện thế là đại lượng đặc trưng cho khả năng sinh công tại một điểm." },
            { q: "Hiệu điện thế $U_{MN}$ giữa hai điểm M và N bằng:", options: ["$V_N - V_M$", "$V_M - V_N$", "$V_M + V_N$", "$V_M \\cdot V_N$"], a: 1, expl: "$U_{MN} = V_M - V_N$." },
            { q: "Công thức liên hệ $E$ và $U$ trong điện trường đều là:", options: ["$U = E/d$", "$E = U \\cdot d$", "$E = U/d$", "$U = E \\cdot d^2$"], a: 2, expl: "Nhớ mẹo: 'U bằng E nhân d' hay 'E bằng U chia d'." },
            { q: "Một điện tích $2C$ dịch chuyển dưới hiệu điện thế $10V$ thì công lực điện là:", options: ["5 J", "20 J", "0,2 J", "12 J"], a: 1, expl: "$A = qU = 2 \\cdot 10 = 20 J$." },
            { q: "Nếu một điện tích di chuyển vuông góc với đường sức điện thì công lực điện bằng:", options: ["Cực đại", "0", "Cực tiểu", "qEd"], a: 1, expl: "Khi vuông góc, hình chiếu $d = 0 \\Rightarrow A = 0$." },
            { q: "Đơn vị của điện thế là:", options: ["Jun (J)", "Vôn (V)", "Ni-tơn (N)", "Cu-lông (C)"], a: 1, expl: "Điện thế đo bằng Vôn." },
            { q: "Thế năng của một electron tại điểm có điện thế $V = 10V$ là:", options: ["$1,6 \\cdot 10^{-18} J$", "$-1,6 \\cdot 10^{-18} J$", "$10 J$", "$-10 J$"], a: 1, expl: "$W = qV = (-1,6 \\cdot 10^{-19}) \\cdot 10 = -1,6 \\cdot 10^{-18} J$." },
            { q: "Khi di chuyển cùng chiều đường sức điện, điện thế sẽ:", options: ["Tăng dần", "Giảm dần", "Không đổi", "Bằng 0"], a: 1, expl: "Vectơ $\\vec{E}$ luôn hướng từ nơi có điện thế cao sang nơi có điện thế thấp." },
            { q: "Công của lực điện trường không phụ thuộc vào:", options: ["Điện tích q", "Cường độ điện trường", "Hình dạng quỹ đạo", "Vị trí điểm đầu cuối"], a: 2, expl: "Lực điện là lực thế, công không phụ thuộc hình dạng đường đi." },

            // Bài 14: Tụ điện
            { q: "Điện dung $C$ của tụ điện đặc trưng cho:", options: ["Khả năng tích điện", "Khả năng tỏa nhiệt", "Độ bền của tụ", "Thể tích của tụ"], a: 0, expl: "$C$ càng lớn thì tụ tích được càng nhiều điện tích ở cùng một hiệu điện thế." },
            { q: "Công thức tính điện dung là:", options: ["$C = QU$", "$C = Q/U$", "$C = U/Q$", "$C = 1/2 QU$"], a: 1, expl: "$C = Q/U$." },
            { q: "Năng lượng của tụ điện đã tích điện tỉ lệ thuận với:", options: ["Hiệu điện thế U", "Bình phương hiệu điện thế $U^2$", "Căn bậc hai của U", "Nghịch lệ với U"], a: 1, expl: "$W = 1/2 CU^2$." },
            { q: "Đơn vị Fara ($F$) tương đương với:", options: ["$1 V/C$", "$1 C/V$", "$1 J/C$", "$1 C \\cdot V$"], a: 1, expl: "Từ $C = Q/U$, đơn vị là $Coulomb / Volt$." },
            { q: "Khi ghép song song hai tụ điện $C_1$ và $C_2$, điện dung tương đương là:", options: ["$C = C_1 + C_2$", "$C = C_1 \\cdot C_2 / (C_1+C_2)$", "$1/C = 1/C_1 + 1/C_2$", "$C = C_1 - C_2$"], a: 0, expl: "Song song thì cộng điện dung." },
            { q: "Một tụ điện ghi $10 \\mu F - 250V$. Số 250V cho biết:", options: ["Hiệu điện thế tụ luôn có", "Hiệu điện thế định mức (tối đa)", "Hiệu điện thế nạp điện", "Suất điện động"], a: 1, expl: "Đây là giới hạn an toàn của tụ." },
            { q: "Để tăng điện dung của tụ điện phẳng, ta có thể:", options: ["Tăng hiệu điện thế", "Giảm khoảng cách d giữa hai bản", "Giảm diện tích bản tụ", "Rút bớt điện tích"], a: 1, expl: "$C = \\frac{\\varepsilon S}{4\\pi kd}$, $C$ tỉ lệ nghịch với $d$." },
            { q: "Năng lượng của tụ điện tích trữ ở dạng:", options: ["Năng lượng từ trường", "Năng lượng điện trường", "Cơ năng", "Hóa năng"], a: 1, expl: "Năng lượng nằm trong vùng không gian có điện trường giữa hai bản tụ." },
            { q: "Tụ điện có điện dung $2 \\mu F$, tích điện $4 \\mu C$. Hiệu điện thế là:", options: ["8 V", "0,5 V", "2 V", "6 V"], a: 2, expl: "$U = Q/C = 4/2 = 2 V$." },
            { q: "Khi ngắt tụ khỏi nguồn rồi tăng khoảng cách 2 bản, đại lượng nào không đổi?", options: ["Điện dung C", "Hiệu điện thế U", "Điện tích Q", "Năng lượng W"], a: 2, expl: "Ngắt khỏi nguồn thì điện tích bị cô lập nên $Q$ không đổi." },

            // Bổ sung các câu tổng hợp
            { q: "Nguyên tử trung hòa về điện vì:", options: ["Có nhiều electron hơn proton", "Số proton bằng số electron", "Không có điện tích", "Hạt nhân mang điện âm"], a: 1, expl: "Điện tích dương của hạt nhân triệt tiêu điện tích âm của vỏ electron." },
            { q: "Hằng số điện môi của một chất cho biết lực tương tác điện giảm đi bao nhiêu lần so với:", options: ["Kim loại", "Chân không", "Nước", "Không khí"], a: 1, expl: "Hằng số điện môi $\\varepsilon$ lấy chân không làm chuẩn." },
            { q: "Điện phổ là:", options: ["Tập hợp các đường sức điện", "Bảng giá trị điện thế", "Hình ảnh các hạt bụi xếp theo đường sức", "Màu sắc của điện trường"], a: 2, expl: "Điện phổ giúp ta hình dung hình dạng các đường sức điện trong thực tế." },
            { q: "Khi đi ngược chiều đường sức điện của một điện trường đều, điện thế sẽ:", options: ["Tăng", "Giảm", "Không đổi", "Bằng 0"], a: 0, expl: "Chiều $\\vec{E}$ là chiều giảm điện thế, nên đi ngược lại là tăng điện thế." },
            { q: "Một quả cầu kim loại mang điện $q$. Nếu chạm quả cầu này vào một quả cầu khác giống hệt đang trung hòa thì điện tích mỗi quả là:", options: ["q", "2q", "q/2", "0"], a: 2, expl: "Nhiễm điện do tiếp xúc: điện tích chia đều cho hai vật giống nhau." },
            { q: "Công thức $A = q(V_M - V_N)$ đúng cho:", options: ["Chỉ điện trường đều", "Mọi điện trường", "Chỉ điện tích điểm", "Chỉ tụ điện"], a: 1, expl: "Đây là định nghĩa tổng quát về công và điện thế." },
            { q: "Đơn vị $1 nC$ (nanocoulomb) bằng:", options: ["$10^{-3} C$", "$10^{-6} C$", "$10^{-9} C$", "$10^{-12} C$"], a: 2, expl: "Nano là $10^{-9}$." },
            { q: "Bản chất của dòng điện trong kim loại là dòng dịch chuyển có hướng của:", options: ["Ion dương", "Ion âm", "Electron tự do", "Proton"], a: 2, expl: "Kim loại dẫn điện nhờ các electron tự do." },
            { q: "Trong công thức Coulomb, nếu r tăng lên gấp đôi thì F thay đổi như thế nào?", options: ["Tăng 2 lần", "Giảm 2 lần", "Tăng 4 lần", "Giảm 4 lần"], a: 3, expl: "$F \\sim 1/r^2$. r tăng 2 thì F giảm $2^2 = 4$ lần." },
            { q: "Một vật dẫn cân bằng điện thì cường độ điện trường tại một điểm bên trong vật dẫn bằng:", options: ["Cực đại", "Bằng E mặt ngoài", "0", "Phụ thuộc hình dạng"], a: 2, expl: "Trong vật dẫn cân bằng, điện trường bằng 0 để các điện tích không di chuyển thêm nữa." }
        ];

        function App() {
            const [gameState, setGameState] = useState('start');
            const [currentIdx, setCurrentIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [selected, setSelected] = useState(null);
            const [showExpl, setShowExpl] = useState(false);
            const [questions, setQuestions] = useState([]);
            const { playCorrect, playWrong, initAudio } = useSound();

            // Trạng thái chống gian lận
            const [cheatWarnings, setCheatWarnings] = useState(0);
            const [showCheatAlert, setShowCheatAlert] = useState(false);
            const [isTestActive, setIsTestActive] = useState(false);

            // Trạng thái theo dõi thời gian
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [leaderboard, setLeaderboard] = useState([]);
            const [showLeaderboard, setShowLeaderboard] = useState(false);
            const [loadingLeaderboard, setLoadingLeaderboard] = useState(false);

            // Trạng thái đăng nhập
            const [student, setStudent] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : null;
                } catch { return null; }
            });
            const [authMode, setAuthMode] = useState('login'); // 'login' | 'register'
            const [authForm, setAuthForm] = useState({ fullName: '', className: '', password: '' });
            const [authError, setAuthError] = useState('');
            const [authLoading, setAuthLoading] = useState(false);

            // Chế độ admin (xuất Excel)
            const [adminMode, setAdminMode] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');
            const [adminError, setAdminError] = useState('');
            const [exportLoading, setExportLoading] = useState(false);

            const renderMath = useCallback(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise();
                }
            }, []);

            useEffect(() => {
                if (gameState === 'playing' || showExpl || gameState === 'summary') {
                    setTimeout(renderMath, 50);
                }
            }, [currentIdx, gameState, showExpl, renderMath]);

            // Theo dõi thời gian làm bài
            useEffect(() => {
                let interval;
                if (isTestActive && startTime) {
                    interval = setInterval(() => {
                        setElapsedTime(Math.floor((Date.now() - startTime) / 1000));
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isTestActive, startTime]);

            // Lấy dữ liệu bảng xếp hạng
            const fetchLeaderboard = async () => {
                const supabase = getSupabase();
                if (!supabase) return;
                setLoadingLeaderboard(true);
                try {
                    console.log('Đang lấy dữ liệu bảng xếp hạng...');
                    const { data, error } = await supabase.from('leaderboard').select('*').limit(50);
                    if (error) {
                        console.error('Lỗi Supabase:', error);
                        return;
                    }
                    if (data) {
                        console.log('Dữ liệu bảng xếp hạng:', data);
                        console.log('Thông tin user hiện tại:', {
                            name: student?.full_name,
                            class: student?.class_name,
                            score: finalScore,
                            time: elapsedTime
                        });
                        setLeaderboard(data);
                    }
                } catch (err) {
                    console.error('Lỗi lấy bảng xếp hạng:', err);
                } finally {
                    setLoadingLeaderboard(false);
                }
            };

            // Hàm định dạng thời gian từ giây sang phút:giây
            const formatTime = (seconds) => {
                if (!seconds || seconds < 0) return '0:00';
                const secs = Math.floor(seconds);
                const mins = Math.floor(secs / 60);
                const remainingSecs = secs % 60;
                return `${mins}:${remainingSecs.toString().padStart(2, '0')}`;
            };

            // Chống gian lận - theo dõi việc chuyển tab
            useEffect(() => {
                let isCheatDetected = false; // Flag để tránh đếm trùng
                
                const handleCheatDetection = () => {
                    if (isTestActive && !isCheatDetected) {
                        isCheatDetected = true;
                        setCheatWarnings(prev => prev + 1);
                        setShowCheatAlert(true);
                        
                        // Ghi log gian lận
                        console.warn(`CẢNH BÁO GIAN LẬN: ${student?.full_name || 'Unknown'} đã rời khỏi tab thi`);
                        
                        // Reset flag sau 2 giây để có thể phát hiện lần tiếp theo
                        setTimeout(() => {
                            isCheatDetected = false;
                        }, 2000);
                        
                        // Tự động ẩn cảnh báo sau 5 giây
                        setTimeout(() => {
                            setShowCheatAlert(false);
                        }, 5000);
                    }
                };

                const handleVisibilityChange = () => {
                    if (document.hidden) {
                        handleCheatDetection();
                    }
                };

                const handleBeforeUnload = (e) => {
                    if (isTestActive) {
                        e.preventDefault();
                        e.returnValue = 'Bạn đang trong buổi thi. Đóng tab sẽ bị ghi nhận là gian lận!';
                        return e.returnValue;
                    }
                };

                const handleBlur = (e) => {
                    if (isTestActive && e.target === window) {
                        handleCheatDetection();
                    }
                };

                if (isTestActive) {
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                    window.addEventListener('beforeunload', handleBeforeUnload);
                    window.addEventListener('blur', handleBlur);
                }

                return () => {
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                    window.removeEventListener('beforeunload', handleBeforeUnload);
                    window.removeEventListener('blur', handleBlur);
                };
            }, [isTestActive, student]);

            const start = () => {
                initAudio(); // Kích hoạt AudioContext qua tương tác người dùng
                const shuffled = [...questionDatabase].sort(() => Math.random() - 0.5);
                setQuestions(shuffled);
                setCurrentIdx(0);
                setScore(0);
                setSelected(null);
                setShowExpl(false);
                setCheatWarnings(0); // Reset cảnh báo gian lận
                setShowCheatAlert(false);
                setIsTestActive(true); // Bắt đầu theo dõi chống gian lận
                setStartTime(Date.now()); // Bắt đầu đếm thời gian
                setElapsedTime(0);
                setGameState('playing');
            };

            const handleSelect = (idx) => {
                if (selected !== null) return;
                setSelected(idx);
                if (idx === questions[currentIdx].a) {
                    setScore(s => s + 10);
                    playCorrect();
                    confetti({ particleCount: 30, spread: 60, origin: { y: 0.8 } });
                } else {
                    playWrong();
                }
                setShowExpl(true);
            };

            const nextQuestion = () => {
                if (currentIdx < questions.length - 1) {
                    setCurrentIdx(prev => prev + 1);
                    setSelected(null);
                    setShowExpl(false);
                } else {
                    const finalScore = score + (questions[currentIdx] && selected === questions[currentIdx].a ? 10 : 0);
                    const finalTime = elapsedTime;
                    console.log('Kết thúc bài thi - Điểm:', finalScore, 'Thời gian:', finalTime);
                    saveQuizResult(finalScore, cheatWarnings, finalTime);
                    setIsTestActive(false); // Kết thúc theo dõi chống gian lận
                    
                    // Delay 2 giây để đảm bảo dữ liệu được lưu rồi mới lấy bảng xếp hạng
                    setTimeout(() => {
                        console.log('Bắt đầu lấy bảng xếp hạng...');
                        fetchLeaderboard(); // Lấy bảng xếp hạng
                        setShowLeaderboard(true); // Hiển thị bảng xếp hạng
                        setGameState('end');
                    }, 2000);
                }
            };

            const showSummary = () => setGameState('summary');

            const logout = () => {
                setStudent(null);
                localStorage.removeItem(STORAGE_KEY);
                setIsTestActive(false); // Dừng theo dõi khi đăng xuất
                setGameState('start');
            };

            const handleLogin = async (e) => {
                e?.preventDefault();
                setAuthError('');
                if (!authForm.fullName.trim() || !authForm.className.trim() || !authForm.password) {
                    setAuthError('Vui lòng điền đầy đủ họ tên, lớp và mật khẩu.');
                    return;
                }
                const supabase = getSupabase();
                if (!supabase) {
                    setAuthError('Ứng dụng chưa được cấu hình. Vui lòng liên hệ giáo viên.');
                    return;
                }
                setAuthLoading(true);
                try {
                    const pwHash = await hashPassword(authForm.password, authForm.className);
                    const { data, error } = await supabase.from('students').select('id, full_name, class_name')
                        .eq('full_name', authForm.fullName.trim()).eq('class_name', authForm.className.trim()).eq('password_hash', pwHash).single();
                    if (error || !data) {
                        setAuthError('Sai họ tên, lớp hoặc mật khẩu. Nếu chưa có tài khoản, hãy đăng ký.');
                        return;
                    }
                    const s = { id: data.id, full_name: data.full_name, class_name: data.class_name };
                    setStudent(s);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
                    setAuthForm({ fullName: '', className: '', password: '' });
                } catch (err) {
                    setAuthError('Lỗi kết nối. Vui lòng thử lại.');
                } finally { setAuthLoading(false); }
            };

            const handleRegister = async (e) => {
                e?.preventDefault();
                setAuthError('');
                if (!authForm.fullName.trim() || !authForm.className.trim() || !authForm.password) {
                    setAuthError('Vui lòng điền đầy đủ họ tên, lớp và mật khẩu.');
                    return;
                }
                if (authForm.password.length < 4) {
                    setAuthError('Mật khẩu tối thiểu 4 ký tự.');
                    return;
                }
                const supabase = getSupabase();
                if (!supabase) {
                    setAuthError('Ứng dụng chưa được cấu hình. Vui lòng liên hệ giáo viên.');
                    return;
                }
                setAuthLoading(true);
                try {
                    const pwHash = await hashPassword(authForm.password, authForm.className);
                    const { data, error } = await supabase.from('students').insert(
                        { full_name: authForm.fullName.trim(), class_name: authForm.className.trim(), password_hash: pwHash }
                    ).select('id, full_name, class_name').single();
                    if (error) {
                        if (error.code === '23505') setAuthError('Họ tên + lớp đã tồn tại. Hãy đăng nhập với mật khẩu đã đăng ký.');
                        else setAuthError('Đăng ký thất bại. Vui lòng thử lại.');
                        return;
                    }
                    const s = { id: data.id, full_name: data.full_name, class_name: data.class_name };
                    setStudent(s);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
                    setAuthForm({ fullName: '', className: '', password: '' });
                } catch (err) {
                    setAuthError('Lỗi kết nối. Vui lòng thử lại.');
                } finally { setAuthLoading(false); }
            };

            const saveQuizResult = async (finalScore, warnings = 0, timeTaken = 0) => {
                if (!student) return;
                const supabase = getSupabase();
                if (!supabase) return;
                try {
                    const { count } = await supabase.from('quiz_attempts').select('*', { count: 'exact', head: true }).eq('student_id', student.id);
                    await supabase.from('quiz_attempts').insert({
                        student_id: student.id,
                        score: finalScore,
                        total_questions: 50,
                        attempt_number: (count || 0) + 1,
                        time_taken: timeTaken, // Thêm thời gian làm bài
                        cheat_warnings: warnings // Thêm số lần cảnh báo gian lận
                    });
                } catch (err) { console.warn('Không lưu được kết quả:', err); }
            };

            const handleAdminExport = async (e) => {
                e?.preventDefault();
                setAdminError('');
                if (adminPassword !== CONFIG.adminPassword) {
                    setAdminError('Sai mật khẩu giáo viên.');
                    return;
                }
                const supabase = getSupabase();
                if (!supabase) {
                    setAdminError('Chưa cấu hình Supabase. Không thể xuất Excel.');
                    return;
                }
                setExportLoading(true);
                try {
                    const { data: summary, error } = await supabase.from('quiz_summary').select('*');
                    if (error) throw error;
                    const rows = (summary || []).map((r, i) => ({
                        'STT': i + 1,
                        'Họ và tên': r['Họ và tên'] || '',
                        'Lớp': r['Lớp'] || '',
                        'Số lần làm bài': r['Số lần làm bài'] || 0,
                        'Điểm cao nhất': r['Điểm cao nhất'] || 0,
                        'Điểm trung bình': r['Điểm trung bình'] || 0,
                        'Tổng cảnh báo gian lận': r['Tổng cảnh báo gian lận'] || 0,
                        'Cảnh báo cao nhất': r['Cảnh báo cao nhất'] || 0,
                        'Lần đầu làm': r['Lần đầu làm'] ? new Date(r['Lần đầu làm']).toLocaleString('vi-VN') : '',
                        'Lần cuối làm': r['Lần cuối làm'] ? new Date(r['Lần cuối làm']).toLocaleString('vi-VN') : ''
                    }));
                    const ws = window.XLSX.utils.json_to_sheet(rows);
                    const wb = window.XLSX.utils.book_new();
                    window.XLSX.utils.book_append_sheet(wb, ws, 'Kết quả trắc nghiệm');
                    window.XLSX.writeFile(wb, 'ket-qua-trac-nghiem-vatly11-' + new Date().toISOString().slice(0,10) + '.xlsx');
                    setAdminMode(false);
                    setAdminPassword('');
                } catch (err) {
                    setAdminError('Lỗi xuất file. Kiểm tra kết nối Supabase và đã chạy supabase-setup.sql chưa.');
                    console.error(err);
                } finally { setExportLoading(false); }
            };

            // Màn hình đăng nhập / đăng ký (khi chưa đăng nhập)
            if (!student) {
                return (
                    <div className="flex items-center justify-center min-h-screen p-4">
                        <div className="glass-panel p-10 max-w-md w-full border-t-8 border-blue-500 shadow-2xl">
                            <div className="text-center mb-8">
                                <i className="fas fa-user-graduate text-5xl text-blue-500 mb-4"></i>
                                <h1 className="text-2xl font-black text-slate-800">ĐĂNG NHẬP</h1>
                                <p className="text-slate-500 text-sm mt-1">Vật Lí 11 - Chương 3: Điện trường</p>
                            </div>
                            <form onSubmit={authMode === 'login' ? handleLogin : handleRegister} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-slate-600 mb-1">Họ và tên</label>
                                    <input type="text" value={authForm.fullName} onChange={e => setAuthForm(f => ({ ...f, fullName: e.target.value }))}
                                        className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition"
                                        placeholder="Nguyễn Văn A" autoComplete="name" />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-600 mb-1">Lớp</label>
                                    <input type="text" value={authForm.className} onChange={e => setAuthForm(f => ({ ...f, className: e.target.value }))}
                                        className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition"
                                        placeholder="11A1" autoComplete="off" />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-600 mb-1">Mật khẩu</label>
                                    <input type="password" value={authForm.password} onChange={e => setAuthForm(f => ({ ...f, password: e.target.value }))}
                                        className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition"
                                        placeholder="••••••" autoComplete={authMode === 'login' ? 'current-password' : 'new-password'} />
                                </div>
                                {authError && <div className="text-red-600 text-sm bg-red-50 p-3 rounded-xl">{authError}</div>}
                                <button type="submit" disabled={authLoading}
                                    className="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-blue-700 disabled:opacity-60 transition-all">
                                    {authLoading ? 'Đang xử lý...' : (authMode === 'login' ? 'ĐĂNG NHẬP' : 'ĐĂNG KÝ')}
                                </button>
                            </form>
                            <button type="button" onClick={() => { setAuthMode(authMode === 'login' ? 'register' : 'login'); setAuthError(''); }}
                                className="w-full mt-4 text-blue-600 text-sm font-semibold hover:underline">
                                {authMode === 'login' ? 'Chưa có tài khoản? Đăng ký ngay' : 'Đã có tài khoản? Đăng nhập'}
                            </button>
                            <button type="button" onClick={() => setAdminMode(true)}
                                className="w-full mt-6 pt-4 border-t border-slate-200 text-slate-400 text-xs hover:text-slate-600">
                                Giáo viên: Xuất Excel kết quả
                            </button>
                        </div>
                        {adminMode && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => !exportLoading && setAdminMode(false)}>
                                <div className="glass-panel p-8 max-w-sm w-full border-t-8 border-slate-600" onClick={e => e.stopPropagation()}>
                                    <h3 className="text-lg font-black text-slate-800 mb-4">Xuất Excel kết quả</h3>
                                    <form onSubmit={handleAdminExport}>
                                        <input type="password" value={adminPassword} onChange={e => setAdminPassword(e.target.value)}
                                            className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 mb-4" placeholder="Mật khẩu giáo viên" />
                                        {adminError && <div className="text-red-600 text-sm mb-4">{adminError}</div>}
                                        <div className="flex gap-2">
                                            <button type="button" onClick={() => setAdminMode(false)} className="flex-1 py-3 rounded-xl border-2 border-slate-200">Hủy</button>
                                            <button type="submit" disabled={exportLoading} className="flex-1 py-3 rounded-xl bg-slate-700 text-white font-bold">
                                                {exportLoading ? 'Đang xuất...' : 'Xuất Excel'}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (gameState === 'start') return (
                <div className="flex items-center justify-center min-h-screen p-4">
                    <div className="glass-panel p-10 text-center max-w-md w-full border-t-8 border-blue-500 shadow-2xl relative">
                        <button onClick={logout} className="absolute top-4 right-4 p-2 rounded-lg text-slate-400 hover:bg-slate-100 hover:text-slate-600" title="Đăng xuất">
                            <i className="fas fa-sign-out-alt"></i>
                        </button>
                        <div className="mb-2 py-2 px-4 rounded-xl bg-blue-50 inline-block text-blue-700 text-sm font-semibold">
                            <i className="fas fa-user mr-2"></i>{student.full_name} - {student.class_name}
                        </div>
                        <div className="mb-6 relative">
                            <i className="fas fa-bolt text-7xl text-yellow-400 animate-pulse"></i>
                        </div>
                        <h1 className="text-3xl font-black text-slate-800 mb-2">ĐẠI CHIẾN VẬT LÍ 11</h1>
                        <p className="text-slate-500 mb-8 font-semibold">Chương 3: Điện trường</p>
                        
                        <div className="bg-blue-50 p-4 rounded-xl text-left text-sm text-blue-700 mb-6 leading-relaxed">
                            <p><i className="fas fa-book mr-2"></i> Ôn tập kiến thức trước khi làm trắc nghiệm để đạt kết quả tốt nhất.</p>
                            <p><i className="fas fa-music mr-2"></i> Trò chơi sẽ phát tiếng khi chọn đáp án.</p>
                            <p><i className="fas fa-square-root-variable mr-2"></i> Công thức hiển thị dạng LaTeX sắc nét.</p>
                        </div>

                        <button onClick={showSummary} className="w-full bg-slate-100 border-2 border-blue-500 text-blue-600 py-4 rounded-2xl font-bold text-lg shadow-sm hover:bg-blue-50 hover:border-blue-600 transition-all active:scale-95 mb-4">
                            <i className="fas fa-book-open mr-2"></i> ÔN TẬP KIẾN THỨC CHƯƠNG 3
                        </button>
                        <button onClick={start} className="w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xl shadow-lg hover:bg-blue-700 hover:-translate-y-1 transition-all active:scale-95">
                            BẮT ĐẦU NGAY
                        </button>
                        <button type="button" onClick={() => setAdminMode(true)}
                            className="w-full mt-6 pt-4 border-t border-slate-200 text-slate-400 text-xs hover:text-slate-600">
                            Giáo viên: Xuất Excel kết quả
                        </button>
                    </div>
                    {adminMode && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => !exportLoading && setAdminMode(false)}>
                            <div className="glass-panel p-8 max-w-sm w-full border-t-8 border-slate-600" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-black text-slate-800 mb-4">Xuất Excel kết quả</h3>
                                <form onSubmit={handleAdminExport}>
                                    <input type="password" value={adminPassword} onChange={e => setAdminPassword(e.target.value)}
                                        className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 mb-4" placeholder="Mật khẩu giáo viên" />
                                    {adminError && <div className="text-red-600 text-sm mb-4">{adminError}</div>}
                                    <div className="flex gap-2">
                                        <button type="button" onClick={() => setAdminMode(false)} className="flex-1 py-3 rounded-xl border-2 border-slate-200">Hủy</button>
                                        <button type="submit" disabled={exportLoading} className="flex-1 py-3 rounded-xl bg-slate-700 text-white font-bold">
                                            {exportLoading ? 'Đang xuất...' : 'Xuất Excel'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );

            if (gameState === 'summary') return (
                <div className="max-w-3xl mx-auto px-4 py-10 tex2jax_process">
                    <div className="glass-panel p-8 md:p-10 mb-6 border-t-8 border-blue-500 shadow-2xl">
                        <div className="flex items-center justify-between mb-8">
                            <div>
                                <h1 className="text-2xl md:text-3xl font-black text-slate-800">TÓM TẮT KIẾN THỨC CHƯƠNG 3</h1>
                                <p className="text-slate-500 font-semibold mt-1">Điện trường - Ôn tập trước khi làm trắc nghiệm</p>
                            </div>
                            <button onClick={() => setGameState('start')} className="p-3 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-600 transition-all">
                                <i className="fas fa-arrow-left"></i>
                            </button>
                        </div>

                        <div className="space-y-8">
                            {/* Bài 11: Định luật Coulomb */}
                            <div className="bg-blue-50/50 border-2 border-blue-100 rounded-2xl p-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black">11</div>
                                    <h2 className="text-xl font-black text-slate-800">Bài 11: Định luật Coulomb</h2>
                                </div>
                                <ul className="space-y-3 text-slate-700 leading-relaxed">
                                    <li><strong>• Lực tương tác:</strong> {'$F = k \\frac{|q_1 q_2|}{\\varepsilon r^2}$'} với {'$k = 9 \\cdot 10^9 \\, N \\cdot m^2/C^2$'}</li>
                                    <li><strong>• Cùng dấu đẩy nhau</strong>, trái dấu hút nhau. {'$F$'} tỉ lệ nghịch với {'$r^2$'}.</li>
                                    <li><strong>• Hằng số điện môi:</strong> Chân không {'$\\varepsilon = 1$'}. Trong điện môi lực giảm {'$\\varepsilon$'} lần.</li>
                                    <li><strong>• Điện tích nguyên tố:</strong> {'$e = 1,6 \\cdot 10^{-19} C$'}. Electron mang {'$-e$'}.</li>
                                    <li><strong>• Đơn vị k:</strong> {'$N \\cdot m^2 / C^2$'}</li>
                                </ul>
                            </div>

                            {/* Bài 12: Điện trường */}
                            <div className="bg-blue-50/50 border-2 border-blue-100 rounded-2xl p-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black">12</div>
                                    <h2 className="text-xl font-black text-slate-800">Bài 12: Điện trường</h2>
                                </div>
                                <ul className="space-y-3 text-slate-700 leading-relaxed">
                                    <li><strong>• Cường độ điện trường:</strong> {'$\\vec{E} = \\vec{F}/q$'} hoặc {'$E = k \\frac{|Q|}{r^2}$'} (điện tích điểm)</li>
                                    <li><strong>• Đơn vị:</strong> {'$V/m$'}. Lực điện: {'$F = qE$'}.</li>
                                    <li><strong>• Đường sức điện:</strong> Đi ra từ điện tích dương, đi vào điện tích âm. Không cắt nhau.</li>
                                    <li><strong>• Điện trường đều:</strong> {'$\\vec{E}$'} không đổi, đường sức song song cách đều.</li>
                                    <li><strong>• Nguyên lí chồng chất:</strong> {'$\\vec{E} = \\vec{E_1} + \\vec{E_2} + ...$'}</li>
                                </ul>
                            </div>

                            {/* Bài 13: Điện thế - Thế năng */}
                            <div className="bg-blue-50/50 border-2 border-blue-100 rounded-2xl p-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black">13</div>
                                    <h2 className="text-xl font-black text-slate-800">Bài 13: Điện thế - Thế năng</h2>
                                </div>
                                <ul className="space-y-3 text-slate-700 leading-relaxed">
                                    <li><strong>• Công lực điện (điện trường đều):</strong> {'$A = qEd$'} với {'$d$'} là hình chiếu quãng đường lên phương {'$\\vec{E}$'}.</li>
                                    <li><strong>• Công tổng quát:</strong> {'$A = q(V_M - V_N) = qU_{MN}$'}. Không phụ thuộc hình dạng quỹ đạo.</li>
                                    <li><strong>• Hiệu điện thế:</strong> {'$U_{MN} = V_M - V_N$'}. Liên hệ: {'$E = U/d$'} (điện trường đều).</li>
                                    <li><strong>• Điện thế đặc trưng</strong> cho khả năng sinh công. Đơn vị: Vôn (V).</li>
                                    <li><strong>• Chiều {'$\\vec{E}$'}:</strong> Từ nơi điện thế cao sang thấp. Vuông góc đường sức thì {'$A = 0$'}.</li>
                                </ul>
                            </div>

                            {/* Bài 14: Tụ điện */}
                            <div className="bg-blue-50/50 border-2 border-blue-100 rounded-2xl p-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black">14</div>
                                    <h2 className="text-xl font-black text-slate-800">Bài 14: Tụ điện</h2>
                                </div>
                                <ul className="space-y-3 text-slate-700 leading-relaxed">
                                    <li><strong>• Điện dung:</strong> {'$C = Q/U$'}. Đơn vị Fara: {'$1 F = 1 C/V$'}.</li>
                                    <li><strong>• Năng lượng tụ:</strong> {'$W = \\frac{1}{2}CU^2 = \\frac{1}{2}QU$'}. Năng lượng điện trường.</li>
                                    <li><strong>• Tụ phẳng:</strong> {'$C = \\frac{\\varepsilon S}{4\\pi kd}$'}. C tăng khi giảm {'$d$'}, tăng {'$S$'}.</li>
                                    <li><strong>• Ghép song song:</strong> {'$C = C_1 + C_2$'}. Ghép nối tiếp: {'$\\frac{1}{C} = \\frac{1}{C_1} + \\frac{1}{C_2}$'}.</li>
                                    <li><strong>• Ngắt tụ khỏi nguồn:</strong> {'$Q$'} không đổi. Nối nguồn: {'$U$'} không đổi.</li>
                                </ul>
                            </div>

                            {/* Bổ sung tổng hợp */}
                            <div className="bg-slate-50 border-2 border-slate-200 rounded-2xl p-6">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-10 h-10 bg-slate-700 rounded-xl flex items-center justify-center text-white font-black"><i className="fas fa-lightbulb text-sm"></i></div>
                                    <h2 className="text-xl font-black text-slate-800">Kiến thức bổ sung</h2>
                                </div>
                                <ul className="space-y-2 text-slate-700 leading-relaxed text-sm">
                                    <li>• Nguyên tử trung hòa: số proton = số electron.</li>
                                    <li>• Vật dẫn cân bằng: {'$E = 0$'} bên trong.</li>
                                    <li>• Dòng điện trong kim loại: dịch chuyển có hướng của electron tự do.</li>
                                    <li>• Nhiễm điện tiếp xúc: điện tích chia đều cho hai vật giống nhau.</li>
                                </ul>
                            </div>
                        </div>

                        <button onClick={start} className="mt-8 w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xl shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all flex items-center justify-center group">
                            BẮT ĐẦU LÀM TRẮC NGHIỆM
                            <i className="fas fa-chevron-right ml-3 group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                </div>
            );

            if (gameState === 'end') {
                const finalScore = score + (selected !== null && questions[currentIdx] && selected === questions[currentIdx].a ? 10 : 0);
                
                // Nếu đang hiển thị bảng xếp hạng
                if (showLeaderboard) {
                    // Tìm xếp hạng của user hiện tại một cách trực tiếp hơn
                    const currentUserRank = leaderboard.find(item => 
                        student && 
                        item.full_name === student.full_name && 
                        item.class_name === student.class_name &&
                        Math.abs(item.score - finalScore) < 0.01
                    );
                    
                    console.log('User hiện tại:', student);
                    console.log('Final score:', finalScore);
                    console.log('Current user rank:', currentUserRank);
                    
                    return (
                        <div className="max-w-4xl mx-auto px-4 py-10">
                            <div className="glass-panel p-8 md:p-10 border-t-8 border-yellow-500 shadow-2xl">
                                <div className="text-center mb-8">
                                    <i className="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                                    <h1 className="text-3xl font-black text-slate-800 mb-2">BẢNG XẾP HẠNG</h1>
                                    <p className="text-slate-500">Vật Lí 11 - Chương 3: Điện trường</p>
                                </div>

                                {/* Kết quả của bạn */}
                                <div className="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6 mb-8">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <h3 className="font-bold text-blue-800 text-lg mb-2">Kết quả của bạn</h3>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                <div>
                                                    <div className="text-2xl font-black text-blue-600">{finalScore}</div>
                                                    <div className="text-sm text-blue-600">Điểm</div>
                                                </div>
                                                <div>
                                                    <div className="text-2xl font-black text-blue-600">{formatTime(elapsedTime)}</div>
                                                    <div className="text-sm text-blue-600">Thời gian</div>
                                                </div>
                                                <div>
                                                    <div className="text-2xl font-black text-blue-600">#{currentUserRank?.rank_position || '-'}</div>
                                                    <div className="text-sm text-blue-600">Xếp hạng</div>
                                                </div>
                                                <div>
                                                    <div className="text-2xl font-black text-red-600">{cheatWarnings}</div>
                                                    <div className="text-sm text-red-600">Cảnh báo</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Bảng xếp hạng */}
                                <div className="bg-white rounded-2xl overflow-hidden shadow-lg">
                                    <div className="bg-gradient-to-r from-yellow-500 to-orange-500 text-white p-4">
                                        <h3 className="font-bold text-lg">Top 50 Thí Sinh</h3>
                                    </div>
                                    {loadingLeaderboard ? (
                                        <div className="p-8 text-center">
                                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                            <p className="mt-2 text-slate-600">Đang tải bảng xếp hạng...</p>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead className="bg-slate-50 border-b">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left text-sm font-bold text-slate-700">#</th>
                                                        <th className="px-4 py-3 text-left text-sm font-bold text-slate-700">Họ và tên</th>
                                                        <th className="px-4 py-3 text-left text-sm font-bold text-slate-700">Lớp</th>
                                                        <th className="px-4 py-3 text-center text-sm font-bold text-slate-700">Điểm</th>
                                                        <th className="px-4 py-3 text-center text-sm font-bold text-slate-700">Thời gian</th>
                                                        <th className="px-4 py-3 text-center text-sm font-bold text-slate-700">Cảnh báo</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {leaderboard.map((item, index) => {
                                                        // Logic linh hoạt hơn để tìm user hiện tại
                                                        const isCurrentUser = student && 
                                                                           item.full_name === student.full_name && 
                                                                           item.class_name === student.class_name &&
                                                                           Math.abs(item.score - finalScore) < 0.01; // Cho phép sai số nhỏ
                                                        return (
                                                            <tr key={index} className={`border-b hover:bg-slate-50 ${isCurrentUser ? 'bg-blue-50 font-bold' : ''}`}>
                                                                <td className="px-4 py-3">
                                                                    {item.rank_position <= 3 ? (
                                                                        <span className={`inline-flex items-center justify-center w-8 h-8 rounded-full font-bold text-white ${
                                                                            item.rank_position === 1 ? 'bg-yellow-500' : 
                                                                            item.rank_position === 2 ? 'bg-gray-400' : 'bg-orange-600'
                                                                        }`}>
                                                                            {item.rank_position}
                                                                        </span>
                                                                    ) : (
                                                                        <span className="text-slate-600 font-medium">{item.rank_position}</span>
                                                                    )}
                                                                </td>
                                                                <td className="px-4 py-3">
                                                                    <div className="flex items-center">
                                                                        {isCurrentUser && <i className="fas fa-star text-yellow-500 mr-2"></i>}
                                                                        <span className={isCurrentUser ? 'text-blue-700' : 'text-slate-700'}>
                                                                            {item.full_name}
                                                                        </span>
                                                                    </div>
                                                                </td>
                                                                <td className="px-4 py-3 text-slate-600">{item.class_name}</td>
                                                                <td className="px-4 py-3 text-center">
                                                                    <span className={`font-bold ${isCurrentUser ? 'text-blue-700 text-lg' : 'text-slate-700'}`}>
                                                                        {item.score}
                                                                    </span>
                                                                </td>
                                                                <td className="px-4 py-3 text-center text-slate-600">
                                                                    {formatTime(item.time_taken || 0)}
                                                                </td>
                                                                <td className="px-4 py-3 text-center">
                                                                    {item.cheat_warnings > 0 ? (
                                                                        <span className="text-red-600 font-bold">{item.cheat_warnings}</span>
                                                                    ) : (
                                                                        <span className="text-green-600">0</span>
                                                                    )}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-4 mt-8">
                                    <button onClick={start} className="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-all">
                                        <i className="fas fa-redo mr-2"></i>Làm lại
                                    </button>
                                    <button onClick={() => { setShowLeaderboard(false); setGameState('start'); }} className="flex-1 bg-slate-100 text-slate-600 py-4 rounded-xl font-semibold hover:bg-slate-200">
                                        <i className="fas fa-home mr-2"></i>Về trang chủ
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }

                // Màn hình kết quả cũ (nếu không hiển thị bảng xếp hạng)
                return (
                    <div className="flex items-center justify-center min-h-screen p-4">
                        <div className="glass-panel p-10 text-center max-w-md w-full shadow-2xl border-t-8 border-blue-500">
                            <i className="fas fa-trophy text-6xl text-yellow-500 mb-6"></i>
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">HOÀN THÀNH THỬ THÁCH</h2>
                            <div className="text-7xl font-black text-blue-600 mb-4">{finalScore}</div>
                            <p className="text-slate-400 font-bold mb-2">ĐIỂM SỐ CỦA BẠN</p>
                            
                            {/* Hiển thị cảnh báo gian lận */}
                            {cheatWarnings > 0 && (
                                <div className="mb-4 p-4 bg-red-50 border-2 border-red-200 rounded-xl">
                                    <div className="text-red-600 font-bold mb-2">
                                        <i className="fas fa-exclamation-triangle mr-2"></i>
                                        CẢNH BÁO GIAN LẬN
                                    </div>
                                    <div className="text-red-500 text-sm">
                                        Bạn đã bị ghi nhận {cheatWarnings} lần vi phạm quy chế thi
                                    </div>
                                </div>
                            )}
                            
                            <p className="text-slate-400 text-sm mb-6">Kết quả đã được lưu. Giáo viên có thể xuất Excel để xem.</p>
                            <button onClick={start} className="w-full bg-slate-800 text-white py-4 rounded-xl font-bold hover:bg-black transition-all mb-3">
                                THỬ THÁCH LẠI
                            </button>
                            <button onClick={() => setGameState('start')} className="w-full bg-slate-100 text-slate-600 py-3 rounded-xl font-semibold hover:bg-slate-200">
                                VỀ TRANG CHỦ
                            </button>
                        </div>
                    </div>
                );
            }

            const q = questions[currentIdx];

            return (
                <div className="max-w-2xl mx-auto px-4 py-10 tex2jax_process">
                    {/* Cảnh báo gian lận */}
                    {showCheatAlert && (
                        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-red-600 text-white px-6 py-4 rounded-xl shadow-2xl border-2 border-red-700 animate-pulse">
                            <div className="flex items-center gap-3">
                                <i className="fas fa-exclamation-triangle text-2xl"></i>
                                <div>
                                    <div className="font-bold text-lg">CẢNH BÁO GIAN LẬN!</div>
                                    <div className="text-sm">Bạn đã rời khỏi tab thi. Lần {cheatWarnings}</div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-6">
                        <div className="bg-white px-4 py-2 rounded-xl shadow-sm border font-bold text-slate-600">
                            Câu {currentIdx + 1}/50
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="bg-green-100 text-green-700 px-3 py-2 rounded-xl border border-green-200 font-bold text-sm">
                                <i className="fas fa-clock mr-1"></i>
                                {formatTime(elapsedTime)}
                            </div>
                            {cheatWarnings > 0 && (
                                <div className="bg-red-100 text-red-600 px-3 py-2 rounded-xl border border-red-200 font-bold text-sm">
                                    <i className="fas fa-exclamation-triangle mr-1"></i>
                                    {cheatWarnings} cảnh báo
                                </div>
                            )}
                            <div className="bg-blue-600 px-6 py-2 rounded-xl shadow-md text-white font-black">
                                <i className="fas fa-star mr-2 text-yellow-300"></i> {score}
                            </div>
                        </div>
                    </div>

                    <div className="w-full bg-slate-200 h-2 rounded-full mb-8 overflow-hidden">
                        <div className="bg-blue-500 h-full rounded-full transition-all duration-300" style={{width: `${((currentIdx + 1)/50)*100}%`}}></div>
                    </div>

                    <div className="glass-panel p-8 md:p-12 mb-6">
                        <h2 className="text-xl md:text-2xl font-extrabold text-slate-800 mb-10 leading-snug">
                            {q.q}
                        </h2>

                        <div className="grid gap-4">
                            {q.options.map((opt, i) => {
                                let style = "border-slate-100 text-slate-700 hover:border-blue-200 hover:bg-blue-50";
                                if (selected !== null) {
                                    if (i === q.a) style = "border-green-500 bg-green-50 text-green-700 font-bold ring-2 ring-green-100";
                                    else if (i === selected) style = "border-red-500 bg-red-50 text-red-700 font-bold ring-2 ring-red-100";
                                    else style = "border-transparent text-slate-300 opacity-50";
                                }
                                return (
                                    <button 
                                        key={i}
                                        disabled={selected !== null}
                                        onClick={() => handleSelect(i)}
                                        className={`btn-opt p-5 rounded-2xl border-2 text-left flex items-center shadow-sm ${style}`}
                                    >
                                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center mr-4 font-black transition-colors ${selected === null ? 'bg-slate-100 text-slate-500' : (i===q.a ? 'bg-green-500 text-white' : 'bg-red-500 text-white')}`}>
                                            {String.fromCharCode(65+i)}
                                        </div>
                                        <span className="text-lg">{opt}</span>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {showExpl && (
                        <div className="explanation-anim bg-white border-2 border-blue-500 p-8 rounded-3xl shadow-xl mb-12">
                            <div className="flex items-center mb-4 text-blue-600 font-black uppercase tracking-widest text-sm">
                                <div className="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <i className="fas fa-brain text-xs"></i>
                                </div>
                                Phân tích vật lí
                            </div>
                            <div className="text-lg text-slate-700 leading-relaxed bg-slate-50 p-5 rounded-2xl border border-slate-100 italic">
                                {q.expl}
                            </div>
                            <button 
                                onClick={nextQuestion}
                                className="mt-8 w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all flex items-center justify-center group"
                            >
                                {currentIdx === 49 ? 'XEM KẾT QUẢ' : 'CÂU TIẾP THEO'}
                                <i className="fas fa-chevron-right ml-3 group-hover:translate-x-1 transition-transform"></i>
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
