<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vật Lí 11 - Trắc Nghiệm 4 Chương</title>
    
    <!-- Scripts CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Import các file JS của chúng ta (QUAN TRỌNG: ĐÚNG THỨ TỰ) -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="database-chapter1.js"></script>
    <script src="database-chapter2.js"></script>
    <script src="database-chapter3.js"></script>
    <script src="database-chapter4.js"></script>
    <script src="database-index.js"></script>
    <script src="components.js"></script>
    <script src="admin.js"></script>
    
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <style>
        body { font-family: 'Nunito', sans-serif; background: #f1f5f9; }
        .glass-panel { background: white; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .btn-opt { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-opt:active { transform: scale(0.98); }
        .explanation-anim { animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ========== APP CHÍNH - ĐÃ ĐƯỢC TỐI ƯU ==========
        const { useState, useEffect, useCallback, useRef } = React;

        function App() {
            // States
            const [gameState, setGameState] = useState('start');
            const [currentIdx, setCurrentIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [selected, setSelected] = useState(null);
            const [showExpl, setShowExpl] = useState(false);
            const [questions, setQuestions] = useState([]);
            const [selectedChapter, setSelectedChapter] = useState(3);
            
            // Cheat detection
            const [cheatWarnings, setCheatWarnings] = useState(0);
            const [showCheatAlert, setShowCheatAlert] = useState(false);
            const [isTestActive, setIsTestActive] = useState(false);
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            
            // Leaderboard
            const [leaderboard, setLeaderboard] = useState([]);
            const [showLeaderboard, setShowLeaderboard] = useState(false);
            const [loadingLeaderboard, setLoadingLeaderboard] = useState(false);
            
            // Auth
            const [student, setStudent] = useState(() => {
                try {
                    const saved = localStorage.getItem(window.CONFIG?.storageKey || 'vatly11_student');
                    return saved ? JSON.parse(saved) : null;
                } catch { return null; }
            });
            
            // Admin
            const [adminMode, setAdminMode] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');
            const [adminError, setAdminError] = useState('');
            const [exportLoading, setExportLoading] = useState(false);

            // Sound (giữ nguyên code cũ)
            const audioCtx = useRef(null);
            const initAudio = () => {
                if (!audioCtx.current) {
                    audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.current.state === 'suspended') {
                    audioCtx.current.resume();
                }
            };
            const playCorrect = () => {
                initAudio();
                const osc = audioCtx.current.createOscillator();
                const gain = audioCtx.current.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, audioCtx.current.currentTime);
                osc.frequency.exponentialRampToValueAtTime(880, audioCtx.current.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.current.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.current.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(audioCtx.current.destination);
                osc.start();
                osc.stop(audioCtx.current.currentTime + 0.3);
                confetti({ particleCount: 30, spread: 60, origin: { y: 0.8 } });
            };
            const playWrong = () => {
                initAudio();
                const osc = audioCtx.current.createOscillator();
                const gain = audioCtx.current.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.current.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.current.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, audioCtx.current.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, audioCtx.current.currentTime + 0.2);
                osc.connect(gain);
                gain.connect(audioCtx.current.destination);
                osc.start();
                osc.stop(audioCtx.current.currentTime + 0.2);
            };

            // Timer
            useEffect(() => {
                let interval;
                if (isTestActive && startTime) {
                    interval = setInterval(() => {
                        setElapsedTime(Math.floor((Date.now() - startTime) / 1000));
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isTestActive, startTime]);

            // MathJax rerender
            useEffect(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    setTimeout(() => window.MathJax.typesetPromise(), 50);
                }
            }, [currentIdx, gameState, showExpl]);

            // Cheat detection
            useEffect(() => {
                let isCheatDetected = false;
                
                const handleCheatDetection = () => {
                    if (isTestActive && !isCheatDetected) {
                        isCheatDetected = true;
                        setCheatWarnings(prev => prev + 1);
                        setShowCheatAlert(true);
                        setTimeout(() => {
                            isCheatDetected = false;
                            setShowCheatAlert(false);
                        }, 5000);
                    }
                };

                const handleVisibilityChange = () => {
                    if (document.hidden) handleCheatDetection();
                };

                if (isTestActive) {
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                }

                return () => {
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                };
            }, [isTestActive]);

            // Functions
            const start = (chapter) => {
                initAudio();
                const chapterQuestions = window.getQuestionsByChapter?.(chapter, 50) || [];
                setQuestions(chapterQuestions);
                setSelectedChapter(chapter);
                setCurrentIdx(0);
                setScore(0);
                setSelected(null);
                setShowExpl(false);
                setCheatWarnings(0);
                setIsTestActive(true);
                setStartTime(Date.now());
                setElapsedTime(0);
                setGameState('playing');
            };

            const handleSelect = (idx) => {
                if (selected !== null) return;
                setSelected(idx);
                if (idx === questions[currentIdx].a) {
                    setScore(s => s + 10);
                    playCorrect();
                } else {
                    playWrong();
                }
                setShowExpl(true);
            };

            const nextQuestion = () => {
                if (currentIdx < questions.length - 1) {
                    setCurrentIdx(prev => prev + 1);
                    setSelected(null);
                    setShowExpl(false);
                } else {
                    const finalScore = score + (selected === questions[currentIdx]?.a ? 10 : 0);
                    const finalTime = elapsedTime;
                    
                    window.saveQuizResult?.(student, finalScore, cheatWarnings, finalTime, selectedChapter);
                    
                    setIsTestActive(false);
                    
                    setTimeout(async () => {
                        const data = await window.fetchLeaderboard?.() || [];
                        setLeaderboard(data);
                        setShowLeaderboard(true);
                        setGameState('end');
                    }, 2000);
                }
            };

            const logout = () => {
                setStudent(null);
                localStorage.removeItem(window.CONFIG?.storageKey || 'vatly11_student');
                setIsTestActive(false);
                setGameState('start');
            };

            const handleAdminExport = async (e) => {
                e?.preventDefault();
                setAdminError('');
                
                const result = await window.exportToExcel?.(adminPassword) || { success: false, error: 'Lỗi' };
                
                if (result.success) {
                    setAdminMode(false);
                    setAdminPassword('');
                } else {
                    setAdminError(result.error || 'Lỗi không xác định');
                }
            };

            // Render
            if (!student) {
                // Login screen (giữ nguyên code login từ file cũ)
                return (
                    <div className="flex items-center justify-center min-h-screen p-4">
                        <div className="glass-panel p-10 max-w-md w-full border-t-8 border-blue-500">
                            <h1 className="text-2xl font-black text-center mb-6">ĐĂNG NHẬP</h1>
                            <p className="text-center text-slate-500 mb-6">Vật Lí 11 - Trắc nghiệm 4 chương</p>
                            
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                // Tạm thời cho login giả để test
                                const fakeStudent = {
                                    id: 1,
                                    full_name: 'Học sinh',
                                    class_name: '11A1'
                                };
                                setStudent(fakeStudent);
                                localStorage.setItem(window.CONFIG?.storageKey || 'vatly11_student', JSON.stringify(fakeStudent));
                            }}>
                                <input 
                                    type="text" 
                                    placeholder="Họ và tên" 
                                    className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 mb-4"
                                />
                                <input 
                                    type="text" 
                                    placeholder="Lớp" 
                                    className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 mb-4"
                                />
                                <input 
                                    type="password" 
                                    placeholder="Mật khẩu" 
                                    className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 mb-6"
                                />
                                <button 
                                    type="submit"
                                    className="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700"
                                >
                                    ĐĂNG NHẬP
                                </button>
                            </form>
                            
                            <button 
                                onClick={() => setAdminMode(true)}
                                className="w-full mt-6 text-slate-400 text-sm hover:text-slate-600"
                            >
                                Giáo viên: Xuất Excel
                            </button>
                        </div>
                        
                        {/* Admin modal */}
                        {adminMode && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4" onClick={() => setAdminMode(false)}>
                                <div className="glass-panel p-8 max-w-sm w-full" onClick={e => e.stopPropagation()}>
                                    <h3 className="text-lg font-black mb-4">Xuất Excel</h3>
                                    <form onSubmit={handleAdminExport}>
                                        <input 
                                            type="password" 
                                            value={adminPassword}
                                            onChange={e => setAdminPassword(e.target.value)}
                                            className="w-full px-4 py-3 rounded-xl border-2 mb-4"
                                            placeholder="Mật khẩu giáo viên"
                                        />
                                        {adminError && <div className="text-red-600 text-sm mb-4">{adminError}</div>}
                                        <div className="flex gap-2">
                                            <button type="button" onClick={() => setAdminMode(false)} className="flex-1 py-3 rounded-xl border-2">Hủy</button>
                                            <button type="submit" className="flex-1 py-3 rounded-xl bg-slate-700 text-white">Xuất</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // Chapter selection
            if (gameState === 'start') {
                return <window.ChapterSelectionScreen 
                    onSelectChapter={start}
                    onLogout={logout}
                    student={student}
                />;
            }

            // Summary
            if (gameState === 'summary') {
                return <window.SummaryScreen 
                    chapter={selectedChapter}
                    onBack={() => setGameState('start')}
                    onStart={() => start(selectedChapter)}
                />;
            }

            // End game
            if (gameState === 'end') {
                if (showLeaderboard) {
                    return (
                        <div className="max-w-4xl mx-auto px-4 py-10">
                            <div className="glass-panel p-8 border-t-8 border-yellow-500">
                                <h1 className="text-3xl font-black text-center mb-8">BẢNG XẾP HẠNG</h1>
                                
                                <div className="bg-blue-50 rounded-2xl p-6 mb-8">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div>
                                            <div className="text-2xl font-black text-blue-600">{score}</div>
                                            <div className="text-sm">Điểm</div>
                                        </div>
                                        <div>
                                            <div className="text-2xl font-black text-blue-600">{window.formatTime?.(elapsedTime) || '0:00'}</div>
                                            <div className="text-sm">Thời gian</div>
                                        </div>
                                        <div>
                                            <div className="text-2xl font-black text-red-600">{cheatWarnings}</div>
                                            <div className="text-sm">Cảnh báo</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <table className="w-full">
                                    <thead className="bg-slate-50">
                                        <tr>
                                            <th className="px-4 py-3 text-left">#</th>
                                            <th className="px-4 py-3 text-left">Họ tên</th>
                                            <th className="px-4 py-3 text-left">Lớp</th>
                                            <th className="px-4 py-3 text-center">Điểm</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {leaderboard.map((item, idx) => (
                                            <tr key={idx} className="border-b">
                                                <td className="px-4 py-3">{idx + 1}</td>
                                                <td className="px-4 py-3">{item.full_name}</td>
                                                <td className="px-4 py-3">{item.class_name}</td>
                                                <td className="px-4 py-3 text-center font-bold">{item.score}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                
                                <div className="flex gap-4 mt-8">
                                    <button onClick={() => start(selectedChapter)} className="flex-1 bg-blue-600 text-white py-4 rounded-xl">Làm lại</button>
                                    <button onClick={() => setGameState('start')} className="flex-1 bg-slate-100 py-4 rounded-xl">Về trang chủ</button>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                return (
                    <div className="flex items-center justify-center min-h-screen p-4">
                        <div className="glass-panel p-10 text-center max-w-md">
                            <i className="fas fa-trophy text-6xl text-yellow-500 mb-6"></i>
                            <h2 className="text-2xl font-bold mb-2">HOÀN THÀNH</h2>
                            <div className="text-7xl font-black text-blue-600 mb-4">{score}</div>
                            <p className="text-slate-400 mb-6">Điểm số của bạn</p>
                            {cheatWarnings > 0 && (
                                <div className="mb-4 p-4 bg-red-50 rounded-xl text-red-600">
                                    Cảnh báo gian lận: {cheatWarnings} lần
                                </div>
                            )}
                            <button onClick={() => start(selectedChapter)} className="w-full bg-slate-800 text-white py-4 rounded-xl mb-3">
                                LÀM LẠI
                            </button>
                            <button onClick={() => setGameState('start')} className="w-full bg-slate-100 py-3 rounded-xl">
                                VỀ TRANG CHỦ
                            </button>
                        </div>
                    </div>
                );
            }

            // Playing
            return (
                <window.QuizScreen
                    question={questions[currentIdx]}
                    currentIdx={currentIdx}
                    totalQuestions={50}
                    score={score}
                    elapsedTime={elapsedTime}
                    cheatWarnings={cheatWarnings}
                    showCheatAlert={showCheatAlert}
                    selected={selected}
                    onSelect={handleSelect}
                    showExpl={showExpl}
                    onNext={nextQuestion}
                />
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>