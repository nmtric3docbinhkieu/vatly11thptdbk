<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Quản lý Vật Lí 11</title>
    
    <!-- Scripts CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Import các file JS -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Nunito', sans-serif; background: #f1f5f9; }
        .glass-panel { background: white; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function AdminApp() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            
            // Dữ liệu
            const [students, setStudents] = useState([]);
            const [pendingStudents, setPendingStudents] = useState([]);
            const [quizAttempts, setQuizAttempts] = useState([]);
            const [selectedTab, setSelectedTab] = useState('dashboard');
            const [searchTerm, setSearchTerm] = useState('');
            
            // Modal states
            const [showResetModal, setShowResetModal] = useState(false);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [newPassword, setNewPassword] = useState('');
            
            // Thống kê
            const [stats, setStats] = useState({
                totalStudents: 0,
                totalAttempts: 0,
                avgScore: 0,
                passRate: 0,
                topStudents: []
            });

            useEffect(() => {
                if (isLoggedIn) {
                    loadAllData();
                }
            }, [isLoggedIn]);

            const loadAllData = async () => {
                setLoading(true);
                await Promise.all([
                    loadStudents(),
                    loadPendingStudents(),
                    loadQuizAttempts()
                ]);
                setLoading(false);
            };

            const loadStudents = async () => {
                const supabase = window.getSupabase();
                if (!supabase) return;
                
                const { data } = await supabase
                    .from('students')
                    .select('*')
                    .eq('is_approved', true)
                    .order('full_name');
                
                if (data) setStudents(data);
            };

            const loadPendingStudents = async () => {
                const supabase = window.getSupabase();
                if (!supabase) return;
                
                const { data } = await supabase
                    .from('students')
                    .select('*')
                    .eq('is_approved', false)
                    .order('created_at', { ascending: false });
                
                if (data) setPendingStudents(data);
            };

            const loadQuizAttempts = async () => {
                const supabase = window.getSupabase();
                if (!supabase) return;
                
                const { data } = await supabase
                    .from('quiz_attempts')
                    .select('*, students(*)')
                    .order('created_at', { ascending: false });
                
                if (data) {
                    setQuizAttempts(data);
                    calculateStats(data);
                }
            };

            const calculateStats = (attempts) => {
                if (!attempts || attempts.length === 0) return;
                
                const totalAttempts = attempts.length;
                const totalScore = attempts.reduce((sum, a) => sum + a.score, 0);
                const avgScore = (totalScore / totalAttempts).toFixed(2);
                const passCount = attempts.filter(a => a.score >= 40).length;
                const passRate = ((passCount / totalAttempts) * 100).toFixed(1);
                
                // Top students
                const studentScores = {};
                attempts.forEach(a => {
                    if (a.students) {
                        const name = a.students.full_name;
                        if (!studentScores[name] || a.score > studentScores[name].score) {
                            studentScores[name] = {
                                name,
                                class: a.students.class_name,
                                score: a.score,
                                date: a.created_at
                            };
                        }
                    }
                });
                
                const topStudents = Object.values(studentScores)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 5);
                
                setStats({
                    totalStudents: students.length,
                    totalAttempts,
                    avgScore,
                    passRate,
                    topStudents
                });
            };

            // ===== XỬ LÝ ĐĂNG NHẬP =====
            const handleLogin = (e) => {
                e.preventDefault();
                if (password === window.CONFIG.adminPassword) {
                    setIsLoggedIn(true);
                    setError('');
                } else {
                    setError('Sai mật khẩu giáo viên');
                }
            };

            // ===== XỬ LÝ PHÊ DUYỆT =====
            const handleApprove = async (studentId) => {
                const supabase = window.getSupabase();
                const { error } = await supabase
                    .from('students')
                    .update({ is_approved: true })
                    .eq('id', studentId);
                
                if (!error) {
                    loadPendingStudents();
                    loadStudents();
                }
            };

            const handleReject = async (studentId) => {
                if (!confirm('Xóa học sinh này?')) return;
                
                const supabase = window.getSupabase();
                const { error } = await supabase
                    .from('students')
                    .delete()
                    .eq('id', studentId);
                
                if (!error) {
                    loadPendingStudents();
                }
            };

            // ===== XỬ LÝ RESET MẬT KHẨU =====
            const handleResetPassword = async () => {
                if (!selectedStudent || !newPassword) return;
                
                const pwHash = await window.hashPassword(newPassword, selectedStudent.class_name);
                
                const supabase = window.getSupabase();
                const { error } = await supabase
                    .from('students')
                    .update({ password_hash: pwHash })
                    .eq('id', selectedStudent.id);
                
                if (!error) {
                    alert(`Đã reset mật khẩu cho ${selectedStudent.full_name} thành: ${newPassword}`);
                    setShowResetModal(false);
                    setSelectedStudent(null);
                    setNewPassword('');
                }
            };

            // ===== XUẤT EXCEL =====
            const exportToExcel = async () => {
                const rows = quizAttempts.map((a, i) => ({
                    'STT': i + 1,
                    'Họ tên': a.students?.full_name || '',
                    'Lớp': a.students?.class_name || '',
                    'Điểm': a.score,
                    'TG làm bài (giây)': a.time_taken || 0,
                    'Cảnh báo': a.cheat_warnings || 0,
                    'Ngày làm': new Date(a.created_at).toLocaleString('vi-VN')
                }));
                
                const ws = window.XLSX.utils.json_to_sheet(rows);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, 'Kết quả');
                window.XLSX.writeFile(wb, `ket-qua-${new Date().toISOString().slice(0,10)}.xlsx`);
            };

            // ===== XUẤT EXCEL DANH SÁCH HỌC SINH =====
            const exportStudentsToExcel = () => {
                const rows = students.map((s, i) => ({
                    'STT': i + 1,
                    'Họ tên': s.full_name,
                    'Lớp': s.class_name,
                    'Ngày tạo': new Date(s.created_at).toLocaleString('vi-VN')
                }));
                
                const ws = window.XLSX.utils.json_to_sheet(rows);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, 'Học sinh');
                window.XLSX.writeFile(wb, `hoc-sinh-${new Date().toISOString().slice(0,10)}.xlsx`);
            };

            // ===== FILTER HỌC SINH =====
            const filteredStudents = students.filter(s => 
                s.full_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                s.class_name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            // ===== MÀN HÌNH ĐĂNG NHẬP =====
            if (!isLoggedIn) {
                return (
                    <div className="flex items-center justify-center min-h-screen p-4">
                        <div className="glass-panel p-10 max-w-md w-full border-t-8 border-slate-700">
                            <div className="text-center mb-8">
                                <i className="fas fa-user-cog text-5xl text-slate-700 mb-4"></i>
                                <h1 className="text-2xl font-black text-slate-800">GIÁO VIÊN</h1>
                                <p className="text-slate-500 text-sm">Quản lý hệ thống Vật Lí 11</p>
                            </div>
                            
                            <form onSubmit={handleLogin}>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 mb-4"
                                    placeholder="Mật khẩu giáo viên"
                                    autoFocus
                                />
                                {error && <p className="text-red-600 text-sm mb-4">{error}</p>}
                                <button
                                    type="submit"
                                    className="w-full bg-slate-700 text-white py-4 rounded-2xl font-bold hover:bg-slate-800"
                                >
                                    ĐĂNG NHẬP
                                </button>
                            </form>
                            
                            <a
                                href="index.html"
                                className="block text-center mt-6 text-slate-400 text-sm hover:text-slate-600"
                            >
                                ← Quay lại trang chính
                            </a>
                        </div>
                    </div>
                );
            }

            // ===== TRANG QUẢN TRỊ CHÍNH =====
            return (
                <div className="min-h-screen bg-slate-100">
                    {/* Header */}
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <i className="fas fa-chart-line text-2xl text-blue-600"></i>
                                <h1 className="text-xl font-bold text-slate-800">Quản trị Vật Lí 11</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                <span className="text-sm text-slate-500">
                                    <i className="far fa-clock mr-1"></i>
                                    {new Date().toLocaleDateString('vi-VN')}
                                </span>
                                <button
                                    onClick={() => setIsLoggedIn(false)}
                                    className="px-4 py-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100"
                                >
                                    <i className="fas fa-sign-out-alt mr-2"></i>Đăng xuất
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="max-w-7xl mx-auto px-4 py-6">
                        <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                            <button
                                onClick={() => setSelectedTab('dashboard')}
                                className={`px-6 py-3 rounded-xl font-semibold transition-all ${
                                    selectedTab === 'dashboard' 
                                    ? 'bg-blue-600 text-white shadow-lg' 
                                    : 'bg-white text-slate-600 hover:bg-slate-50'
                                }`}
                            >
                                <i className="fas fa-chart-pie mr-2"></i>Tổng quan
                            </button>
                            <button
                                onClick={() => setSelectedTab('pending')}
                                className={`px-6 py-3 rounded-xl font-semibold transition-all ${
                                    selectedTab === 'pending' 
                                    ? 'bg-blue-600 text-white shadow-lg' 
                                    : 'bg-white text-slate-600 hover:bg-slate-50'
                                } relative`}
                            >
                                <i className="fas fa-user-clock mr-2"></i>Chờ duyệt
                                {pendingStudents.length > 0 && (
                                    <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center">
                                        {pendingStudents.length}
                                    </span>
                                )}
                            </button>
                            <button
                                onClick={() => setSelectedTab('students')}
                                className={`px-6 py-3 rounded-xl font-semibold transition-all ${
                                    selectedTab === 'students' 
                                    ? 'bg-blue-600 text-white shadow-lg' 
                                    : 'bg-white text-slate-600 hover:bg-slate-50'
                                }`}
                            >
                                <i className="fas fa-users mr-2"></i>Học sinh
                            </button>
                            <button
                                onClick={() => setSelectedTab('results')}
                                className={`px-6 py-3 rounded-xl font-semibold transition-all ${
                                    selectedTab === 'results' 
                                    ? 'bg-blue-600 text-white shadow-lg' 
                                    : 'bg-white text-slate-600 hover:bg-slate-50'
                                }`}
                            >
                                <i className="fas fa-clipboard-list mr-2"></i>Kết quả
                            </button>
                            <button
                                onClick={() => setSelectedTab('stats')}
                                className={`px-6 py-3 rounded-xl font-semibold transition-all ${
                                    selectedTab === 'stats' 
                                    ? 'bg-blue-600 text-white shadow-lg' 
                                    : 'bg-white text-slate-600 hover:bg-slate-50'
                                }`}
                            >
                                <i className="fas fa-chart-bar mr-2"></i>Thống kê
                            </button>
                        </div>

                        {/* Nội dung theo tab */}
                        {loading ? (
                            <div className="text-center py-20">
                                <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
                                <p className="mt-4 text-slate-600">Đang tải dữ liệu...</p>
                            </div>
                        ) : (
                            <>
                                {/* TAB: TỔNG QUAN */}
                                {selectedTab === 'dashboard' && (
                                    <div className="space-y-6">
                                        {/* Stats cards */}
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                            <div className="stat-card glass-panel p-6 border-l-4 border-blue-600">
                                                <p className="text-sm text-slate-500 mb-2">Tổng học sinh</p>
                                                <p className="text-3xl font-bold text-slate-800">{students.length}</p>
                                                <i className="fas fa-user-graduate absolute top-4 right-4 text-3xl text-blue-200"></i>
                                            </div>
                                            <div className="stat-card glass-panel p-6 border-l-4 border-green-600">
                                                <p className="text-sm text-slate-500 mb-2">Lượt làm bài</p>
                                                <p className="text-3xl font-bold text-slate-800">{stats.totalAttempts}</p>
                                                <i className="fas fa-pen absolute top-4 right-4 text-3xl text-green-200"></i>
                                            </div>
                                            <div className="stat-card glass-panel p-6 border-l-4 border-yellow-600">
                                                <p className="text-sm text-slate-500 mb-2">Điểm trung bình</p>
                                                <p className="text-3xl font-bold text-slate-800">{stats.avgScore}</p>
                                                <i className="fas fa-star absolute top-4 right-4 text-3xl text-yellow-200"></i>
                                            </div>
                                            <div className="stat-card glass-panel p-6 border-l-4 border-purple-600">
                                                <p className="text-sm text-slate-500 mb-2">Tỉ lệ đạt (≥40)</p>
                                                <p className="text-3xl font-bold text-slate-800">{stats.passRate}%</p>
                                                <i className="fas fa-check-circle absolute top-4 right-4 text-3xl text-purple-200"></i>
                                            </div>
                                        </div>

                                        {/* Top students */}
                                        <div className="glass-panel p-6">
                                            <h3 className="font-bold text-lg text-slate-800 mb-4">
                                                <i className="fas fa-crown text-yellow-500 mr-2"></i>
                                                Top 5 học sinh điểm cao nhất
                                            </h3>
                                            <div className="space-y-3">
                                                {stats.topStudents.map((s, i) => (
                                                    <div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                                        <div className="flex items-center gap-3">
                                                            <span className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${
                                                                i === 0 ? 'bg-yellow-500 text-white' :
                                                                i === 1 ? 'bg-gray-400 text-white' :
                                                                i === 2 ? 'bg-orange-600 text-white' :
                                                                'bg-slate-200 text-slate-700'
                                                            }`}>
                                                                {i + 1}
                                                            </span>
                                                            <div>
                                                                <p className="font-bold">{s.name}</p>
                                                                <p className="text-sm text-slate-500">Lớp {s.class}</p>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="text-xl font-bold text-blue-600">{s.score}</p>
                                                            <p className="text-xs text-slate-400">{new Date(s.date).toLocaleDateString()}</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Quick actions */}
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            <button
                                                onClick={exportToExcel}
                                                className="glass-panel p-6 text-left hover:shadow-lg transition-all group"
                                            >
                                                <i className="fas fa-file-excel text-3xl text-green-600 mb-3"></i>
                                                <h4 className="font-bold">Xuất Excel kết quả</h4>
                                                <p className="text-sm text-slate-500 mt-1">Tải về file kết quả làm bài</p>
                                            </button>
                                            <button
                                                onClick={exportStudentsToExcel}
                                                className="glass-panel p-6 text-left hover:shadow-lg transition-all group"
                                            >
                                                <i className="fas fa-users text-3xl text-blue-600 mb-3"></i>
                                                <h4 className="font-bold">Xuất danh sách lớp</h4>
                                                <p className="text-sm text-slate-500 mt-1">Danh sách học sinh đã duyệt</p>
                                            </button>
                                            <a
                                                href="index.html"
                                                className="glass-panel p-6 text-left hover:shadow-lg transition-all group block"
                                            >
                                                <i className="fas fa-arrow-left text-3xl text-slate-600 mb-3"></i>
                                                <h4 className="font-bold">Về trang chính</h4>
                                                <p className="text-sm text-slate-500 mt-1">Quay lại giao diện học sinh</p>
                                            </a>
                                        </div>
                                    </div>
                                )}

                                {/* TAB: CHỜ DUYỆT */}
                                {selectedTab === 'pending' && (
                                    <div className="glass-panel p-6">
                                        <h3 className="font-bold text-lg text-slate-800 mb-4">
                                            <i className="fas fa-user-clock mr-2 text-yellow-500"></i>
                                            Học sinh chờ duyệt ({pendingStudents.length})
                                        </h3>
                                        
                                        {pendingStudents.length === 0 ? (
                                            <p className="text-center text-slate-500 py-8">Không có học sinh chờ duyệt</p>
                                        ) : (
                                            <div className="space-y-3">
                                                {pendingStudents.map(s => (
                                                    <div key={s.id} className="p-4 bg-slate-50 rounded-xl flex items-center justify-between">
                                                        <div>
                                                            <p className="font-bold">{s.full_name}</p>
                                                            <p className="text-sm text-slate-500">Lớp: {s.class_name}</p>
                                                            <p className="text-xs text-slate-400">
                                                                Đăng ký: {new Date(s.created_at).toLocaleString('vi-VN')}
                                                            </p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => handleApprove(s.id)}
                                                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                                            >
                                                                <i className="fas fa-check mr-1"></i>Duyệt
                                                            </button>
                                                            <button
                                                                onClick={() => handleReject(s.id)}
                                                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                                                            >
                                                                <i className="fas fa-times mr-1"></i>Từ chối
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* TAB: HỌC SINH */}
                                {selectedTab === 'students' && (
                                    <div className="glass-panel p-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold text-lg text-slate-800">
                                                <i className="fas fa-users mr-2 text-blue-600"></i>
                                                Danh sách học sinh ({filteredStudents.length})
                                            </h3>
                                            <div className="flex gap-2">
                                                <input
                                                    type="text"
                                                    placeholder="Tìm kiếm..."
                                                    value={searchTerm}
                                                    onChange={(e) => setSearchTerm(e.target.value)}
                                                    className="px-4 py-2 rounded-xl border-2 border-slate-200"
                                                />
                                                <button
                                                    onClick={exportStudentsToExcel}
                                                    className="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700"
                                                >
                                                    <i className="fas fa-file-excel mr-2"></i>Xuất Excel
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead className="bg-slate-50 border-b">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left">STT</th>
                                                        <th className="px-4 py-3 text-left">Họ tên</th>
                                                        <th className="px-4 py-3 text-left">Lớp</th>
                                                        <th className="px-4 py-3 text-left">Ngày tạo</th>
                                                        <th className="px-4 py-3 text-center">Thao tác</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {filteredStudents.map((s, i) => (
                                                        <tr key={s.id} className="border-b hover:bg-slate-50">
                                                            <td className="px-4 py-3">{i + 1}</td>
                                                            <td className="px-4 py-3 font-medium">{s.full_name}</td>
                                                            <td className="px-4 py-3">{s.class_name}</td>
                                                            <td className="px-4 py-3 text-sm text-slate-500">
                                                                {new Date(s.created_at).toLocaleDateString()}
                                                            </td>
                                                            <td className="px-4 py-3 text-center">
                                                                <button
                                                                    onClick={() => {
                                                                        setSelectedStudent(s);
                                                                        setShowResetModal(true);
                                                                    }}
                                                                    className="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200"
                                                                >
                                                                    <i className="fas fa-key mr-1"></i>Reset MK
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* TAB: KẾT QUẢ */}
                                {selectedTab === 'results' && (
                                    <div className="glass-panel p-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold text-lg text-slate-800">
                                                <i className="fas fa-clipboard-list mr-2 text-green-600"></i>
                                                Lịch sử làm bài ({quizAttempts.length})
                                            </h3>
                                            <button
                                                onClick={exportToExcel}
                                                className="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700"
                                            >
                                                <i className="fas fa-file-excel mr-2"></i>Xuất Excel
                                            </button>
                                        </div>
                                        
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead className="bg-slate-50 border-b">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left">STT</th>
                                                        <th className="px-4 py-3 text-left">Họ tên</th>
                                                        <th className="px-4 py-3 text-left">Lớp</th>
                                                        <th className="px-4 py-3 text-center">Điểm</th>
                                                        <th className="px-4 py-3 text-center">TG (giây)</th>
                                                        <th className="px-4 py-3 text-center">Cảnh báo</th>
                                                        <th className="px-4 py-3 text-left">Ngày làm</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {quizAttempts.map((a, i) => (
                                                        <tr key={a.id} className="border-b hover:bg-slate-50">
                                                            <td className="px-4 py-3">{i + 1}</td>
                                                            <td className="px-4 py-3 font-medium">{a.students?.full_name}</td>
                                                            <td className="px-4 py-3">{a.students?.class_name}</td>
                                                            <td className="px-4 py-3 text-center">
                                                                <span className={`font-bold ${
                                                                    a.score >= 40 ? 'text-green-600' : 'text-red-600'
                                                                }`}>
                                                                    {a.score}
                                                                </span>
                                                            </td>
                                                            <td className="px-4 py-3 text-center">{a.time_taken || 0}</td>
                                                            <td className="px-4 py-3 text-center">
                                                                {a.cheat_warnings > 0 ? (
                                                                    <span className="text-red-600">{a.cheat_warnings}</span>
                                                                ) : (
                                                                    <span className="text-green-600">0</span>
                                                                )}
                                                            </td>
                                                            <td className="px-4 py-3 text-sm text-slate-500">
                                                                {new Date(a.created_at).toLocaleString()}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* TAB: THỐNG KÊ */}
                                {selectedTab === 'stats' && (
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="glass-panel p-6">
                                                <h4 className="font-bold mb-4">Phân bố điểm</h4>
                                                <div className="space-y-3">
                                                    {['0-20', '21-30', '31-40', '41-50'].map((range, i) => {
                                                        const [min, max] = range.split('-').map(Number);
                                                        const count = quizAttempts.filter(a => 
                                                            a.score >= min && a.score <= max
                                                        ).length;
                                                        const percentage = ((count / quizAttempts.length) * 100).toFixed(1);
                                                        
                                                        return (
                                                            <div key={i}>
                                                                <div className="flex justify-between text-sm mb-1">
                                                                    <span>{range} điểm</span>
                                                                    <span className="font-bold">{count} ({percentage}%)</span>
                                                                </div>
                                                                <div className="w-full bg-slate-200 h-2 rounded-full">
                                                                    <div 
                                                                        className="bg-blue-600 h-2 rounded-full"
                                                                        style={{ width: `${percentage}%` }}
                                                                    ></div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                            
                                            <div className="glass-panel p-6">
                                                <h4 className="font-bold mb-4">Thống kê theo lớp</h4>
                                                <div className="space-y-4">
                                                    {[...new Set(students.map(s => s.class_name))].map(className => {
                                                        const classStudents = students.filter(s => s.class_name === className);
                                                        const classAttempts = quizAttempts.filter(a => 
                                                            a.students?.class_name === className
                                                        );
                                                        const avgScore = classAttempts.length > 0
                                                            ? (classAttempts.reduce((sum, a) => sum + a.score, 0) / classAttempts.length).toFixed(1)
                                                            : 0;
                                                        
                                                        return (
                                                            <div key={className} className="p-3 bg-slate-50 rounded-xl">
                                                                <div className="flex justify-between items-center">
                                                                    <div>
                                                                        <p className="font-bold">Lớp {className}</p>
                                                                        <p className="text-sm text-slate-500">
                                                                            {classStudents.length} học sinh · {classAttempts.length} lượt làm
                                                                        </p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <p className="text-xl font-bold text-blue-600">{avgScore}</p>
                                                                        <p className="text-xs text-slate-400">Điểm TB</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>

                    {/* Modal reset mật khẩu */}
                    {showResetModal && selectedStudent && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="glass-panel p-8 max-w-md w-full">
                                <h3 className="text-lg font-black text-slate-800 mb-4">
                                    Reset mật khẩu cho {selectedStudent.full_name}
                                </h3>
                                
                                <input
                                    type="text"
                                    value={newPassword}
                                    onChange={(e) => setNewPassword(e.target.value)}
                                    className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 mb-4"
                                    placeholder="Mật khẩu mới"
                                />
                                
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setShowResetModal(false)}
                                        className="flex-1 py-3 rounded-xl border-2 border-slate-200"
                                    >
                                        Hủy
                                    </button>
                                    <button
                                        onClick={handleResetPassword}
                                        className="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700"
                                    >
                                        Xác nhận
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>